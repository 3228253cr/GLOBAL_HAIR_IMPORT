<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××œ××™ - Global Imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        .sidebar { width: 200px; min-height: 100vh; position: fixed; right: 0; top: 0; }
        .main-content { margin-right: 200px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: white; transition: all 0.3s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .gold-gradient { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 24px; border-radius: 8px; color: white; }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toastContainer"></div>

    <!-- ×¡×¨×’×œ ×¦×“ ×§×‘×•×¢ -->
    <aside class="sidebar bg-gray-800 shadow-xl">
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" alt="Logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-white font-bold">Global Imports</h1>
                    <p class="text-gray-400 text-xs">Premium Hair Supply</p>
                </div>
            </div>
        </div>
        
        <nav class="py-4">
            <a href="dashboard.html" class="nav-item">
                <span>ğŸ“Š</span>
                <span>×“×©×‘×•×¨×“</span>
            </a>
            <a href="suppliers.html" class="nav-item">
                <span>ğŸ­</span>
                <span>×¡×¤×§×™×</span>
            </a>
            <a href="trips.html" class="nav-item">
                <span>âœˆï¸</span>
                <span>× ×¡×™×¢×•×ª</span>
            </a>
            <a href="products.html" class="nav-item">
                <span>ğŸ“¦</span>
                <span>××•×¦×¨×™×</span>
            </a>
            <a href="customers.html" class="nav-item">
                <span>ğŸ‘¥</span>
                <span>×œ×§×•×—×•×ª</span>
            </a>
            <a href="orders.html" class="nav-item">
                <span>ğŸ“‹</span>
                <span>×”×–×× ×•×ª</span>
            </a>
            <a href="invoices.html" class="nav-item">
                <span>ğŸ§¾</span>
                <span>×—×©×‘×•× ×™×•×ª</span>
            </a>
            <a href="inventory.html" class="nav-item active">
                <span>ğŸ“¦</span>
                <span>××œ××™</span>
            </a>
            <a href="reports.html" class="nav-item">
                <span>ğŸ“ˆ</span>
                <span>×“×•×—×•×ª</span>
            </a>
            <a href="maintenance.html" class="nav-item">
                <span>âš™ï¸</span>
                <span>×ª×—×–×•×§×”</span>
            </a>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
            <div class="text-gray-400 text-sm mb-2" id="welcomeUser"></div>
            <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                <span>ğŸšª</span>
                <span>×”×ª× ×ª×§</span>
            </button>
        </div>
    </aside>

    <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
    <div class="main-content">
        <main class="p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ“¦ × ×™×”×•×œ ××œ××™</h1>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- ××œ××™ ×›×œ×œ×™ -->
                <div class="stat-card card p-6 border-r-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ğŸ“¦ ××œ××™ ×›×œ×œ×™</p>
                            <p class="text-3xl font-bold text-blue-600" id="totalInventory">0</p>
                            <p class="text-xs text-gray-400">×’×¨×</p>
                        </div>
                        <div class="text-4xl">ğŸ“¦</div>
                    </div>
                </div>

                <!-- ×”×•×¢×‘×¨ ×œ×¡×•×›× ×™× -->
                <div class="stat-card card p-6 border-r-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ğŸ¤ ×”×•×¢×‘×¨ ×œ×¡×•×›× ×™×</p>
                            <p class="text-3xl font-bold text-purple-600" id="transferredToAgents">0</p>
                            <p class="text-xs text-gray-400">×’×¨×</p>
                        </div>
                        <div class="text-4xl">ğŸ¤</div>
                    </div>
                </div>

                <!-- × ××›×¨ ×¢"×™ ×¡×•×›× ×™× -->
                <div class="stat-card card p-6 border-r-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">âœ… × ××›×¨ ×¢"×™ ×¡×•×›× ×™×</p>
                            <p class="text-3xl font-bold text-green-600" id="soldByAgents">0</p>
                            <p class="text-xs text-gray-400">×’×¨×</p>
                        </div>
                        <div class="text-4xl">âœ…</div>
                    </div>
                </div>

                <!-- ×–××™×Ÿ ×‘××—×¡×Ÿ -->
                <div class="stat-card card p-6 border-r-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ğŸª ×–××™×Ÿ ×‘××—×¡×Ÿ</p>
                            <p class="text-3xl font-bold text-yellow-600" id="availableInventory">0</p>
                            <p class="text-xs text-gray-400">×’×¨×</p>
                        </div>
                        <div class="text-4xl">ğŸª</div>
                    </div>
                </div>
            </div>

            <!-- ×”×¢×‘×¨×” ×œ×¡×•×›×Ÿ -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ¤ ×”×¢×‘×¨×ª ××œ××™ ×œ×¡×•×›×Ÿ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×‘×—×¨ ×¡×•×›×Ÿ</label>
                        <select id="selectAgent" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">-- ×‘×—×¨ ×¡×•×›×Ÿ --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×›××•×ª (×’×¨×)</label>
                        <input type="number" id="transferQty" class="w-full px-4 py-2 border rounded-lg" placeholder="0" onchange="calcTransferTotal()">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">××—×™×¨ ×¦×¤×•×™ ×œ×’×¨× ($)</label>
                        <input type="number" step="0.01" id="transferPrice" class="w-full px-4 py-2 border rounded-lg" placeholder="0" onchange="calcTransferTotal()">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×¡×”"×› ×¦×¤×•×™ ($)</label>
                        <input type="text" id="transferTotal" class="w-full px-4 py-2 border rounded-lg bg-yellow-50 font-bold" readonly>
                    </div>
                    <div class="flex items-end">
                        <button onclick="transferToAgent()" class="w-full gold-gradient text-gray-900 font-bold py-2 rounded-lg hover:opacity-90 transition">
                            ğŸ“¤ ×”×¢×‘×¨ ×œ×¡×•×›×Ÿ
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×”×¢×¨×•×ª</label>
                    <input type="text" id="transferNotes" class="w-full px-4 py-2 border rounded-lg" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)">
                </div>
            </div>

            <!-- ×”×™×¡×˜×•×¨×™×™×ª ×”×¢×‘×¨×•×ª -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×”×¢×‘×¨×•×ª ×œ×¡×•×›× ×™×</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                                <th class="px-4 py-3 text-right">×›××•×ª</th>
                                <th class="px-4 py-3 text-right">××—×™×¨ ×œ×’×¨×</th>
                                <th class="px-4 py-3 text-right">×¡×”"×› ×¦×¤×•×™</th>
                                <th class="px-4 py-3 text-right">×”×¢×¨×•×ª</th>
                                <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="transfersTableBody">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ×¡×˜×˜×•×¡ ×¡×•×›× ×™× -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¥ ×¡×˜×˜×•×¡ ××œ××™ ×¡×•×›× ×™×</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                                <th class="px-4 py-3 text-right">×§×™×‘×œ</th>
                                <th class="px-4 py-3 text-right">××›×¨</th>
                                <th class="px-4 py-3 text-right">× ×•×ª×¨</th>
                                <th class="px-4 py-3 text-right">×¡×”"×› ×—×™×™×‘</th>
                                <th class="px-4 py-3 text-right">×¡×˜×˜×•×¡</th>
                            </tr>
                        </thead>
                        <tbody id="agentsStatusBody">
                            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Check login
        function checkLogin() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            const userData = JSON.parse(user);
            document.getElementById('welcomeUser').textContent = `×©×œ×•×, ${userData.username}`;
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Format number
        function formatNumber(num) {
            return num ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('he-IL');
        }

        // Load agents for dropdown
        async function loadAgentsDropdown() {
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name');

                const select = document.getElementById('selectAgent');
                select.innerHTML = '<option value="">-- ×‘×—×¨ ×¡×•×›×Ÿ --</option>';

                if (data && data.length > 0) {
                    data.forEach(agent => {
                        select.innerHTML += `<option value="${agent.id}">${agent.name}</option>`;
                    });
                }
            } catch (err) {
                console.error('Error loading agents:', err);
            }
        }

        // Calculate transfer total
        function calcTransferTotal() {
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            document.getElementById('transferTotal').value = '$' + formatNumber(qty * price);
        }

        // Transfer to agent
        async function transferToAgent() {
            const agentId = document.getElementById('selectAgent').value;
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            const notes = document.getElementById('transferNotes').value;

            if (!agentId) {
                showToast('× × ×œ×‘×—×•×¨ ×¡×•×›×Ÿ', 'error');
                return;
            }
            if (qty <= 0) {
                showToast('× × ×œ×”×–×™×Ÿ ×›××•×ª', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('agent_inventory')
                    .insert({
                        agent_id: agentId,
                        quantity_received: qty,
                        expected_price: price,
                        total_expected: qty * price,
                        date_received: new Date().toISOString().split('T')[0],
                        notes: notes
                    });

                if (error) throw error;

                showToast('×”××œ××™ ×”×•×¢×‘×¨ ×œ×¡×•×›×Ÿ ×‘×”×¦×œ×—×”!');
                
                // × ×§×” ×˜×•×¤×¡
                document.getElementById('selectAgent').value = '';
                document.getElementById('transferQty').value = '';
                document.getElementById('transferPrice').value = '';
                document.getElementById('transferTotal').value = '';
                document.getElementById('transferNotes').value = '';

                // ×¨×¢× ×Ÿ × ×ª×•× ×™×
                loadAllData();

            } catch (err) {
                showToast('×©×’×™××” ×‘×”×¢×‘×¨×ª ×”××œ××™', 'error');
                console.error(err);
            }
        }

        // Load inventory stats
        async function loadInventoryStats() {
            try {
                // ××œ××™ ××¨×›×™×©×•×ª (products)
                const { data: products } = await supabase
                    .from('products')
                    .select('quantity');

                let totalFromPurchases = 0;
                if (products) {
                    products.forEach(p => totalFromPurchases += p.quantity || 0);
                }

                // ××œ××™ ×©×”×•×¢×‘×¨ ×œ×¡×•×›× ×™×
                const { data: agentInv } = await supabase
                    .from('agent_inventory')
                    .select('quantity_received');

                let totalTransferred = 0;
                if (agentInv) {
                    agentInv.forEach(ai => totalTransferred += ai.quantity_received || 0);
                }

                // × ××›×¨ ×¢"×™ ×¡×•×›× ×™×
                const { data: agentSales } = await supabase
                    .from('agent_sales')
                    .select('quantity_sold');

                let totalSoldByAgents = 0;
                if (agentSales) {
                    agentSales.forEach(as => totalSoldByAgents += as.quantity_sold || 0);
                }

                // ×–××™×Ÿ ×‘××—×¡×Ÿ = ×¡×”"×› ×¨×›×™×©×•×ª - ×”×•×¢×‘×¨ ×œ×¡×•×›× ×™×
                const availableInWarehouse = totalFromPurchases - totalTransferred;

                // ×¢×“×›×•×Ÿ ×ª×¦×•×’×”
                document.getElementById('totalInventory').textContent = totalFromPurchases.toLocaleString();
                document.getElementById('transferredToAgents').textContent = totalTransferred.toLocaleString();
                document.getElementById('soldByAgents').textContent = totalSoldByAgents.toLocaleString();
                document.getElementById('availableInventory').textContent = availableInWarehouse.toLocaleString();

            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        // Load transfers history
        async function loadTransfersHistory() {
            try {
                const { data, error } = await supabase
                    .from('agent_inventory')
                    .select(`
                        *,
                        agents(name)
                    `)
                    .order('date_received', { ascending: false });

                const tbody = document.getElementById('transfersTableBody');

                if (error || !data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ×”×¢×‘×¨×•×ª ×¢×“×™×™×Ÿ</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(t => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${formatDate(t.date_received)}</td>
                        <td class="px-4 py-3 font-bold">${t.agents?.name || '×œ× ×™×“×•×¢'}</td>
                        <td class="px-4 py-3">${(t.quantity_received || 0).toLocaleString()} ×’×¨×</td>
                        <td class="px-4 py-3">$${formatNumber(t.expected_price)}</td>
                        <td class="px-4 py-3 font-bold text-red-600">$${formatNumber(t.total_expected)}</td>
                        <td class="px-4 py-3 text-gray-500">${t.notes || ''}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteTransfer('${t.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error('Error loading transfers:', err);
            }
        }

        // Delete transfer
        async function deleteTransfer(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×”×¢×‘×¨×”?')) return;

            try {
                const { error } = await supabase
                    .from('agent_inventory')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('×”×”×¢×‘×¨×” × ××—×§×”');
                loadAllData();

            } catch (err) {
                showToast('×©×’×™××” ×‘××—×™×§×”', 'error');
            }
        }

        // Load agents status
        async function loadAgentsStatus() {
            try {
                const { data: agents } = await supabase
                    .from('agents')
                    .select('id, name')
                    .eq('is_active', true);

                if (!agents || agents.length === 0) {
                    document.getElementById('agentsStatusBody').innerHTML = 
                        '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ×¡×•×›× ×™× ×¤×¢×™×œ×™×</td></tr>';
                    return;
                }

                const { data: allInventory } = await supabase
                    .from('agent_inventory')
                    .select('agent_id, quantity_received, total_expected');

                const { data: allSales } = await supabase
                    .from('agent_sales')
                    .select('agent_id, quantity_sold');

                const tbody = document.getElementById('agentsStatusBody');
                tbody.innerHTML = agents.map(agent => {
                    let received = 0;
                    let owed = 0;
                    let sold = 0;

                    if (allInventory) {
                        allInventory.filter(i => i.agent_id === agent.id).forEach(i => {
                            received += i.quantity_received || 0;
                            owed += i.total_expected || 0;
                        });
                    }

                    if (allSales) {
                        allSales.filter(s => s.agent_id === agent.id).forEach(s => {
                            sold += s.quantity_sold || 0;
                        });
                    }

                    const remaining = received - sold;
                    const statusClass = remaining === 0 ? 'text-green-600' : remaining < received * 0.2 ? 'text-yellow-600' : 'text-blue-600';
                    const statusText = remaining === 0 ? 'âœ… ×”×›×œ × ××›×¨' : remaining < received * 0.2 ? 'âš ï¸ ×›××¢×˜ × ×’××¨' : 'ğŸ“¦ ×¤×¢×™×œ';

                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3 font-bold">${agent.name}</td>
                            <td class="px-4 py-3">${received.toLocaleString()} ×’×¨×</td>
                            <td class="px-4 py-3 text-green-600">${sold.toLocaleString()} ×’×¨×</td>
                            <td class="px-4 py-3 font-bold text-blue-600">${remaining.toLocaleString()} ×’×¨×</td>
                            <td class="px-4 py-3 font-bold text-red-600">$${formatNumber(owed)}</td>
                            <td class="px-4 py-3 ${statusClass}">${statusText}</td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading agents status:', err);
            }
        }

        // Load all data
        async function loadAllData() {
            await loadInventoryStats();
            await loadAgentsDropdown();
            await loadTransfersHistory();
            await loadAgentsStatus();
        }

        // Initialize
        checkLogin();
        loadAllData();
    </script>
</body>
</html>
