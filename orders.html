<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Imports - × ×™×”×•×œ ×”×–×× ×•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        .gold-gradient { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideDown 0.3s ease;
        }
        .toast.success { background: #10B981; }
        .toast.error { background: #EF4444; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff40;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
        
        .sidebar { width: 200px; min-height: 100vh; position: fixed; right: 0; top: 0; }
        .main-content { margin-right: 200px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: white; transition: all 0.3s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <div id="toastContainer"></div>

    <!-- ×¡×¨×’×œ ×¦×“ -->
    <aside class="sidebar bg-gray-800 shadow-xl">
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" alt="Logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-white font-bold">Global Imports</h1>
                    <p class="text-gray-400 text-xs">Premium Hair Supply</p>
                </div>
            </div>
        </div>
        
        <nav class="py-4">
            <a href="dashboard.html" class="nav-item"><span>ğŸ“Š</span><span>×“×©×‘×•×¨×“</span></a>
            <a href="suppliers.html" class="nav-item"><span>ğŸ­</span><span>×¡×¤×§×™×</span></a>
            <a href="trips.html" class="nav-item"><span>âœˆï¸</span><span>× ×¡×™×¢×•×ª</span></a>
            <a href="products.html" class="nav-item"><span>ğŸ“¦</span><span>××•×¦×¨×™×</span></a>
            <a href="customers.html" class="nav-item"><span>ğŸ‘¥</span><span>×œ×§×•×—×•×ª</span></a>
            <a href="orders.html" class="nav-item active"><span>ğŸ“‹</span><span>×”×–×× ×•×ª</span></a>
            <a href="invoices.html" class="nav-item"><span>ğŸ§¾</span><span>×—×©×‘×•× ×™×•×ª</span></a>
            <a href="inventory.html" class="nav-item"><span>ğŸ“¦</span><span>××œ××™</span></a>
            <a href="agents-management.html" class="nav-item"><span>ğŸ¤</span><span>×¡×•×›× ×™×</span></a>
            <a href="reports.html" class="nav-item"><span>ğŸ“ˆ</span><span>×“×•×—×•×ª</span></a>
            <a href="maintenance.html" class="nav-item"><span>âš™ï¸</span><span>×ª×—×–×•×§×”</span></a>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
            <div class="text-gray-400 text-sm mb-2" id="welcomeUser"></div>
            <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                <span>ğŸšª</span><span>×”×ª× ×ª×§</span>
            </button>
        </div>
    </aside>

    <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
    <div class="main-content">
        <main class="p-8">

        <div class="flex justify-between items-center mb-8 no-print">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">× ×™×”×•×œ ×”×–×× ×•×ª</h2>
                <p class="text-gray-500">× ×™×”×•×œ ×›×œ ×”×”×–×× ×•×ª ×‘××¢×¨×›×ª</p>
            </div>
            <button onclick="showAddForm()" class="gold-gradient text-white px-6 py-3 rounded-xl hover:opacity-90 transition shadow-lg">+ ×”×–×× ×” ×—×“×©×”</button>
        </div>

        <!-- ×˜×•×¤×¡ ×”×–×× ×” -->
        <div id="formContainer" class="bg-white rounded-2xl shadow-lg p-6 mb-8 hidden no-print">
            <h3 id="formTitle" class="text-2xl font-bold mb-6">×”×–×× ×” ×—×“×©×”</h3>
            <form id="orderForm" onsubmit="saveOrder(event)">
                <input type="hidden" id="orderId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">××¡×¤×¨ ×”×–×× ×”</label>
                        <input type="text" id="order_number" readonly class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 bg-gray-100 font-bold text-blue-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×œ×§×•×— *</label>
                        <select id="customer_id" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-yellow-500 focus:outline-none">
                            <option value="">×‘×—×¨ ×œ×§×•×—...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×ª××¨×™×š ×”×–×× ×”</label>
                        <input type="date" id="order_date" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-yellow-500 focus:outline-none">
                    </div>
                </div>

                <!-- ×¤×¨×™×˜×™ ×”×–×× ×” -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-gray-700">×¤×¨×™×˜×™ ×”×–×× ×”</h4>
                        <button type="button" onclick="addOrderItem()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">+ ×”×•×¡×£ ×¤×¨×™×˜</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border border-gray-200 rounded-xl">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">#</th>
                                    <th class="px-4 py-3 text-right">×¡×•×’ ××•×¦×¨</th>
                                    <th class="px-4 py-3 text-right">×›××•×ª</th>
                                    <th class="px-4 py-3 text-right">××—×™×¨ ×œ×™×—×™×“×”</th>
                                    <th class="px-4 py-3 text-right">×¡×”"×› ×©×•×¨×”</th>
                                    <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsBody"></tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-left font-bold">×¡×”"×› ×œ×¤× ×™ ×”× ×—×”:</td>
                                    <td id="subtotalDisplay" class="px-4 py-3 font-bold">$0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-left font-bold">×”× ×—×” ($):</td>
                                    <td class="px-4 py-3">
                                        <input type="number" id="orderDiscount" step="0.01" oninput="calculateOrderTotal()" class="w-28 border rounded-lg px-3 py-2">
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                                <tr class="bg-blue-50">
                                    <td colspan="3" class="px-4 py-3 text-left font-bold">×¡×”"×› ×”×–×× ×”:</td>
                                    <td id="orderTotalDisplay" class="px-4 py-3 font-bold text-blue-600">$0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                                <tr class="bg-yellow-50">
                                    <td colspan="2" class="px-4 py-3">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="includeVat" onchange="calculateOrderTotal()" class="w-5 h-5 rounded">
                                            <span class="font-medium">×›×•×œ×œ ××¢"× 18%</span>
                                        </label>
                                    </td>
                                    <td class="px-4 py-3 text-left font-bold">×¡×”"×› ×œ×ª×©×œ×•×:</td>
                                    <td id="totalDisplay" class="px-4 py-3 font-bold text-lg text-green-600">$0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- ×©×•×¨×•×ª ×ª×©×œ×•× -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-gray-700">ğŸ’³ ×©×•×¨×•×ª ×ª×©×œ×•×</h4>
                        <div class="flex gap-2">
                            <button type="button" onclick="openCheckModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">ğŸ’³ ×¦'×§×™× ×“×—×•×™×™×</button>
                            <button type="button" onclick="openPaymentModal()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border border-gray-200 rounded-xl">
                            <thead class="bg-purple-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">#</th>
                                    <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                    <th class="px-4 py-3 text-right">×¡×›×•×</th>
                                    <th class="px-4 py-3 text-right">××˜×‘×¢</th>
                                    <th class="px-4 py-3 text-right">×©×¢×¨</th>
                                    <th class="px-4 py-3 text-right">×‘×©"×—</th>
                                    <th class="px-4 py-3 text-right">×××¦×¢×™</th>
                                    <th class="px-4 py-3 text-right">××¡××›×ª×</th>
                                    <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="paymentRowsBody"></tbody>
                            <tfoot class="bg-purple-50">
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-left font-bold">×¡×”"×› ×©×•×œ×:</td>
                                    <td id="totalPaidDisplay" class="px-4 py-3 font-bold text-green-600">â‚ª0.00</td>
                                    <td class="px-4 py-3 text-left font-bold">×™×ª×¨×”:</td>
                                    <td id="balanceDisplay" class="px-4 py-3 font-bold text-red-600">â‚ª0.00</td>
                                    <td colspan="3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- ×”×¢×¨×•×ª -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">×”×¢×¨×•×ª</label>
                    <textarea id="notes" rows="2" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-yellow-500 focus:outline-none"></textarea>
                </div>

                <!-- ×›×¤×ª×•×¨×™× -->
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <div class="text-2xl font-bold">
                        ×¡×”"×›: <span id="totalDisplayBottom">$0.00</span>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button type="submit" id="saveBtn" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">ğŸ’¾ ×©××•×¨</button>
                        <button type="button" onclick="hideForm()" class="bg-gray-400 text-white px-6 py-2 rounded-xl hover:bg-gray-500 transition">×‘×™×˜×•×œ</button>
                        <button type="button" onclick="confirmDeliveryNote()" class="bg-purple-500 text-white px-6 py-2 rounded-xl hover:bg-purple-600 transition">ğŸ“„ ×ª.××©×œ×•×—</button>
                        <button type="button" onclick="confirmInvoice()" class="bg-blue-500 text-white px-6 py-2 rounded-xl hover:bg-blue-600 transition">ğŸ§¾ ×—×©×‘×•× ×™×ª</button>
                        <button type="button" onclick="openCreditModal()" class="bg-orange-500 text-white px-6 py-2 rounded-xl hover:bg-orange-600 transition">â†©ï¸ ×—.×–×™×›×•×™</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ×˜×‘×œ×ª ×”×–×× ×•×ª -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden no-print">
            <div id="loading" class="p-8 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            <div id="emptyMessage" class="p-8 text-center text-gray-500 hidden">××™×Ÿ ×”×–×× ×•×ª ×‘××¢×¨×›×ª</div>
            <table id="ordersTable" class="w-full hidden">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="px-4 py-4 text-right">××¡×¤×¨</th>
                        <th class="px-4 py-4 text-right">×œ×§×•×—</th>
                        <th class="px-4 py-4 text-right">×ª××¨×™×š</th>
                        <th class="px-4 py-4 text-right">×¡×›×•×</th>
                        <th class="px-4 py-4 text-right">×¡×˜×˜×•×¡</th>
                        <th class="px-4 py-4 text-center">×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="printArea" class="hidden"></div>

        </main>
    </div>

    <!-- ========== ××•×“××œ ×¦'×§×™× ×“×—×•×™×™× ========== -->
    <div id="checkModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6">ğŸ’³ ×¦'×§×™× ×“×—×•×™×™×</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×›××” ×ª×©×œ×•××™×?</label>
                    <input type="number" id="checkCount" min="1" value="10" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×¡×›×•× ×›×•×œ×œ (â‚ª)</label>
                    <input type="number" id="checkTotal" step="0.01" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×ª××¨×™×š ×¦'×§ ×¨××©×•×Ÿ</label>
                    <input type="date" id="checkFirstDate" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">××¨×•×•×— ×‘×™×Ÿ ×ª×©×œ×•××™× (×™××™×)</label>
                    <input type="number" id="checkInterval" min="1" value="30" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="closeCheckModal()" class="flex-1 bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500">×‘×™×˜×•×œ</button>
                <button onclick="generateChecks()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">âœ“ ×¦×•×¨ ×ª×©×œ×•××™×</button>
            </div>
        </div>
    </div>

    <!-- ========== ××•×“××œ ×”×•×¡×¤×ª ×ª×©×œ×•× ========== -->
    <div id="paymentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6">ğŸ’° ×”×•×¡×¤×ª ×ª×©×œ×•×</h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×ª××¨×™×š</label>
                        <input type="date" id="paymentDate" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×¡×›×•×</label>
                        <input type="number" id="paymentAmount" step="0.01" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">××˜×‘×¢</label>
                        <select id="paymentCurrency" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            <option value="ILS">â‚ª ×©×§×œ</option>
                            <option value="USD">$ ×“×•×œ×¨</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×©×¢×¨ ×”××¨×”</label>
                        <input type="number" id="paymentRate" step="0.0001" value="3.22" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×××¦×¢×™ ×ª×©×œ×•×</label>
                        <select id="paymentMethod" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                            <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                            <option value="×¦'×§">×¦'×§</option>
                            <option value="××©×¨××™">××©×¨××™</option>
                            <option value="×‘×™×˜">×‘×™×˜</option>
                            <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">××¡××›×ª×</label>
                        <input type="text" id="paymentRef" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3" placeholder="××¡×¤×¨ ××¡××›×ª×">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="closePaymentModal()" class="flex-1 bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500">×‘×™×˜×•×œ</button>
                <button onclick="addPaymentFromModal()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">ğŸ’¾ ×”×•×¡×£ ×ª×©×œ×•×</button>
            </div>
        </div>
    </div>

    <!-- ========== ××•×“××œ ×¢×¨×™×›×ª ×”×–×× ×” ========== -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 800px;">
            <h3 class="text-2xl font-bold mb-6">âœï¸ ×¢×¨×™×›×ª ×”×–×× ×” <span id="editOrderNumber" class="text-blue-600"></span></h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×œ×§×•×—</label>
                        <select id="editCustomerId" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×ª××¨×™×š</label>
                        <input type="date" id="editOrderDate" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×¡×˜×˜×•×¡</label>
                        <select id="editStatus" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            <option value="×˜×™×•×˜×”">×˜×™×•×˜×”</option>
                            <option value="×¤×ª×•×—">×¤×ª×•×—</option>
                            <option value="×‘×ª×”×œ×™×š">×‘×ª×”×œ×™×š</option>
                            <option value="× ×©×œ×—">× ×©×œ×—</option>
                            <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                            <option value="×‘×•×˜×œ">×‘×•×˜×œ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">×”× ×—×” ($)</label>
                        <input type="number" id="editDiscount" step="0.01" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×”×¢×¨×•×ª</label>
                    <textarea id="editNotes" rows="3" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3"></textarea>
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="closeEditModal()" class="flex-1 bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500">×‘×™×˜×•×œ</button>
                <button onclick="saveEditModal()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <!-- ========== ××•×“××œ ××™×©×•×¨ ×ª.××©×œ×•×— ========== -->
    <div id="deliveryConfirmModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-xl font-bold mb-4 text-center">ğŸ“„ ×”×¤×§×ª ×ª×¢×•×“×ª ××©×œ×•×—</h3>
            <p class="text-gray-600 mb-6 text-center">××ª×” ×¢×•××“ ×œ×”×¤×™×§ ×ª×¢×•×“×ª ××©×œ×•×— ×œ×”×–×× ×” ×–×•. ×”×× ×œ×”××©×™×š?</p>
            <div class="flex gap-3">
                <button onclick="closeDeliveryConfirm()" class="flex-1 bg-gray-400 text-white py-2 rounded-xl hover:bg-gray-500">×œ×</button>
                <button onclick="generateDeliveryNote()" class="flex-1 bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700">×›×Ÿ, ×”×¤×§</button>
            </div>
        </div>
    </div>

    <!-- ========== ××•×“××œ ××™×©×•×¨ ×—×©×‘×•× ×™×ª ========== -->
    <div id="invoiceConfirmModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-xl font-bold mb-4 text-center">ğŸ§¾ ×”×¤×§×ª ×—×©×‘×•× ×™×ª</h3>
            <p class="text-gray-600 mb-6 text-center">××ª×” ×¢×•××“ ×œ×”×¤×™×§ ×—×©×‘×•× ×™×ª ×œ×”×–×× ×” ×–×•. ×”×× ×œ×”××©×™×š?</p>
            <div class="flex gap-3">
                <button onclick="closeInvoiceConfirm()" class="flex-1 bg-gray-400 text-white py-2 rounded-xl hover:bg-gray-500">×œ×</button>
                <button onclick="generateInvoice()" class="flex-1 bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700">×›×Ÿ, ×”×¤×§</button>
            </div>
        </div>
    </div>

    <!-- ========== ××•×“××œ ×—×©×‘×•× ×™×ª ×–×™×›×•×™ ========== -->
    <div id="creditModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">â†©ï¸ ×—×©×‘×•× ×™×ª ×–×™×›×•×™</h3>
            <p class="text-gray-600 mb-4">××¡' ×”×–×× ×”: <span id="creditOrderNumber" class="font-bold"></span></p>
            
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">×¡×•×’ ××•×¦×¨</label>
                    <select id="creditProduct" class="w-full border rounded-lg px-3 py-2">
                        <option value="×©×™×¢×¨">×©×™×¢×¨</option>
                        <option value="×§×¦×¨">×§×¦×¨</option>
                        <option value="××¨×•×š">××¨×•×š</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">×›××•×ª</label>
                    <input type="number" id="creditQty" class="w-full border rounded-lg px-3 py-2" oninput="calcCredit()">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">××—×™×¨ ×œ×™×—'</label>
                    <input type="number" id="creditPrice" step="0.01" class="w-full border rounded-lg px-3 py-2" oninput="calcCredit()">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">×¡×”"×›</label>
                    <input type="text" id="creditTotal" readonly class="w-full border rounded-lg px-3 py-2 bg-gray-100 font-bold">
                </div>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">* ×”×›××•×ª ×ª×•×—×–×¨ ×œ××œ××™ ×•×”×¡×›×•× ×™×•×¨×“ ××”×™×ª×¨×”</p>
            
            <div class="flex gap-2">
                <button onclick="closeCreditModal()" class="flex-1 bg-gray-400 text-white py-2 rounded-xl hover:bg-gray-500">×‘×™×˜×•×œ</button>
                <button onclick="saveCreditNote()" class="flex-1 bg-green-600 text-white py-2 rounded-xl hover:bg-green-700">ğŸ’¾ ×©××•×¨</button>
                <button onclick="confirmCreditInvoice()" class="flex-1 bg-orange-500 text-white py-2 rounded-xl hover:bg-orange-600">ğŸ§¾ ×”×¤×§ ×—.×–×™×›×•×™</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        let supabaseClient = null;
        let orders = [];
        let customers = [];
        let products = [];
        let itemCounter = 0;
        let paymentRowCounter = 0;
        let currentExchangeRate = 3.22;
        let currentEditOrderId = null;

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setLoading(btn, loading) {
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '×©×•××¨... <span class="spinner"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ’¾ ×©××•×¨';
            }
        }

        window.onload = function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) { window.location.href = 'index.html'; return; }
            const username = localStorage.getItem('username') || sessionStorage.getItem('username') || '××©×ª××©';
            document.getElementById('welcomeUser').textContent = '×©×œ×•×, ' + username;
            document.getElementById('order_date').value = new Date().toISOString().split('T')[0];
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                loadCustomers();
                loadProducts();
                loadOrders();
            }
        };

        async function loadCustomers() {
            const { data } = await supabaseClient.from('customers').select('*').order('company_name');
            customers = data || [];
            const options = '<option value="">×‘×—×¨ ×œ×§×•×—...</option>' + customers.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
            document.getElementById('customer_id').innerHTML = options;
            document.getElementById('editCustomerId').innerHTML = options;
        }

        async function loadProducts() {
            const { data } = await supabaseClient.from('products').select('*, suppliers(name)').order('product_type');
            products = data || [];
        }

        async function loadOrders() {
            document.getElementById('loading').classList.remove('hidden');
            const { data, error } = await supabaseClient.from('orders').select('*, customers(company_name)').order('created_at', { ascending: false });
            if (error) { document.getElementById('loading').textContent = '×©×’×™××”: ' + error.message; return; }
            orders = data || [];
            renderTable();
        }

        function getStatusBadge(status) {
            const colors = { 
                '×˜×™×•×˜×”': 'bg-gray-100 text-gray-800',
                '×¤×ª×•×—': 'bg-blue-100 text-blue-800', 
                '×‘×ª×”×œ×™×š': 'bg-yellow-100 text-yellow-800', 
                '× ×©×œ×—': 'bg-purple-100 text-purple-800',
                '×”×•×©×œ×': 'bg-green-100 text-green-800', 
                '×‘×•×˜×œ': 'bg-red-100 text-red-800' 
            };
            return `<span class="px-3 py-1 rounded-full text-sm font-medium ${colors[status] || 'bg-gray-100'}">${status}</span>`;
        }

        function renderTable() {
            document.getElementById('loading').classList.add('hidden');
            if (orders.length === 0) { document.getElementById('emptyMessage').classList.remove('hidden'); return; }
            document.getElementById('ordersTable').classList.remove('hidden');
            document.getElementById('tableBody').innerHTML = orders.map((o, i) => {
                const hasDelivery = o.delivery_note_number ? 'bg-gray-400 cursor-default' : 'bg-purple-500 hover:bg-purple-600';
                const hasInvoice = o.invoice_number ? 'bg-gray-400 cursor-default' : 'bg-green-500 hover:bg-green-600';
                return `
                <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-yellow-50">
                    <td class="px-3 py-2 font-semibold">${o.order_number || '-'}</td>
                    <td class="px-3 py-2">${o.customers?.company_name || ''}</td>
                    <td class="px-3 py-2">${o.order_date || ''}</td>
                    <td class="px-3 py-2 font-bold">$${o.total_amount || 0}</td>
                    <td class="px-3 py-2">${getStatusBadge(o.status)}</td>
                    <td class="px-3 py-2">
                        <div class="flex gap-1 justify-center items-center flex-wrap">
                            <span onclick="openEditModal('${o.id}')" class="w-7 h-7 rounded bg-blue-100 text-blue-600 flex items-center justify-center cursor-pointer hover:scale-110" title="×¢×¨×™×›×” ××”×™×¨×”">âœï¸</span>
                            <span onclick="editOrder('${o.id}')" class="w-7 h-7 rounded bg-yellow-100 text-yellow-600 flex items-center justify-center cursor-pointer hover:scale-110" title="×¢×¨×™×›×” ××œ××”">ğŸ“</span>
                            <span onclick="deleteOrder('${o.id}')" class="w-7 h-7 rounded bg-red-100 text-red-600 flex items-center justify-center cursor-pointer hover:scale-110" title="××—×™×§×”">ğŸ—‘ï¸</span>
                            <span class="text-xs px-2 py-1 rounded ${hasDelivery} text-white">${o.delivery_note_number ? '×ª.× âœ“' : '×ª.××©×œ×•×—'}</span>
                            <span class="text-xs px-2 py-1 rounded ${hasInvoice} text-white">${o.invoice_number ? '×—-×ª âœ“' : '×—×©×‘×•× ×™×ª'}</span>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // ========== ××•×“××œ ×¢×¨×™×›×” ××”×™×¨×” ==========
        function openEditModal(id) {
            const o = orders.find(x => x.id === id);
            if (!o) return;
            
            currentEditOrderId = id;
            document.getElementById('editOrderNumber').textContent = o.order_number || '';
            document.getElementById('editCustomerId').value = o.customer_id || '';
            document.getElementById('editOrderDate').value = o.order_date || '';
            document.getElementById('editStatus').value = o.status || '×¤×ª×•×—';
            document.getElementById('editDiscount').value = o.discount || '';
            document.getElementById('editNotes').value = o.notes || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditOrderId = null;
        }

        async function saveEditModal() {
            if (!currentEditOrderId) return;
            
            const updateData = {
                customer_id: document.getElementById('editCustomerId').value || null,
                order_date: document.getElementById('editOrderDate').value || null,
                status: document.getElementById('editStatus').value,
                discount: parseFloat(document.getElementById('editDiscount').value) || 0,
                notes: document.getElementById('editNotes').value
            };
            
            const { error } = await supabaseClient.from('orders').update(updateData).eq('id', currentEditOrderId);
            
            if (error) {
                showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ: ' + error.message, 'error');
                return;
            }
            
            showToast('×”×”×–×× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
            closeEditModal();
            loadOrders();
        }

        // ========== ××•×“××œ ×”×•×¡×¤×ª ×ª×©×œ×•× ==========
        function openPaymentModal() {
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentCurrency').value = 'ILS';
            document.getElementById('paymentRate').value = currentExchangeRate;
            document.getElementById('paymentMethod').value = '××–×•××Ÿ';
            document.getElementById('paymentRef').value = '';
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function addPaymentFromModal() {
            const paymentData = {
                payment_date: document.getElementById('paymentDate').value,
                amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
                currency: document.getElementById('paymentCurrency').value,
                exchange_rate: parseFloat(document.getElementById('paymentRate').value) || currentExchangeRate,
                payment_method: document.getElementById('paymentMethod').value,
                reference_number: document.getElementById('paymentRef').value
            };
            
            if (paymentData.amount <= 0) {
                showToast('×™×© ×œ×”×–×™×Ÿ ×¡×›×•×', 'error');
                return;
            }
            
            addPaymentRow(paymentData);
            closePaymentModal();
            showToast('×”×ª×©×œ×•× × ×•×¡×£!');
        }

        // ========== ××•×“××œ ×¦'×§×™× ×“×—×•×™×™× ==========
        function openCheckModal() {
            const balance = parseFloat(document.getElementById('balanceDisplay')?.textContent.replace('â‚ª', '').replace(/,/g, '')) || 0;
            if (balance > 0) {
                document.getElementById('checkTotal').value = balance.toFixed(2);
            }
            document.getElementById('checkFirstDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('checkModal').classList.remove('hidden');
        }
        
        function closeCheckModal() {
            document.getElementById('checkModal').classList.add('hidden');
        }
        
        function generateChecks() {
            const count = parseInt(document.getElementById('checkCount').value) || 0;
            const total = parseFloat(document.getElementById('checkTotal').value) || 0;
            const firstDate = document.getElementById('checkFirstDate').value;
            const interval = parseInt(document.getElementById('checkInterval').value) || 30;
            
            if (count <= 0 || total <= 0 || !firstDate) {
                showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
                return;
            }
            
            const amountPerCheck = total / count;
            const date = new Date(firstDate);
            
            for (let i = 0; i < count; i++) {
                const checkDate = new Date(date);
                checkDate.setDate(date.getDate() + (i * interval));
                const dateStr = checkDate.toISOString().split('T')[0];
                
                addPaymentRow({
                    payment_date: dateStr,
                    amount: amountPerCheck,
                    currency: 'ILS',
                    exchange_rate: currentExchangeRate,
                    payment_method: "×¦'×§",
                    reference_number: ''
                });
            }
            
            closeCheckModal();
            showToast(`× ×•×¦×¨×• ${count} ×ª×©×œ×•××™× ×‘×”×¦×œ×—×”!`);
        }

        // ========== × ×™×”×•×œ ×¤×¨×™×˜×™ ×”×–×× ×” ==========
        function addOrderItem(item = null) {
            itemCounter++;
            const tbody = document.getElementById('orderItemsBody');
            const row = document.createElement('tr');
            row.id = `item-row-${itemCounter}`;
            row.innerHTML = `
                <td class="px-4 py-2">${itemCounter}</td>
                <td class="px-4 py-2">
                    <select id="product-${itemCounter}" class="w-full border rounded-lg px-2 py-2">
                        <option value="×©×™×¢×¨">×©×™×¢×¨</option>
                        <option value="×§×¦×¨">×§×¦×¨</option>
                        <option value="××¨×•×š">××¨×•×š</option>
                        <option value="×§×¦×¨ ×•××¨×•×š">×§×¦×¨ ×•××¨×•×š</option>
                        <option value="×‘×œ×•× ×“×™× ×™">×‘×œ×•× ×“×™× ×™</option>
                        <option value="××™×•×—×“">××™×•×—×“</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <input type="number" id="qty-${itemCounter}" value="${item?.quantity || ''}" min="1" onchange="calculateRowTotal(${itemCounter})" class="w-20 border rounded-lg px-2 py-2 text-center">
                </td>
                <td class="px-4 py-2">
                    <input type="number" id="price-${itemCounter}" value="${item?.unit_price || ''}" step="0.01" onchange="calculateRowTotal(${itemCounter})" class="w-24 border rounded-lg px-2 py-2 text-center">
                </td>
                <td class="px-4 py-2">
                    <span id="rowtotal-${itemCounter}" class="font-bold">$0.00</span>
                </td>
                <td class="px-4 py-2 text-center">
                    <button type="button" onclick="removeOrderItem(${itemCounter})" class="text-red-500 hover:text-red-700 font-bold text-xl">âœ•</button>
                </td>
            `;
            tbody.appendChild(row);
            
            if (item) {
                document.getElementById(`product-${itemCounter}`).value = item.product_type || '×©×™×¢×¨';
            }
            
            calculateRowTotal(itemCounter);
        }

        function calculateRowTotal(rowId) {
            const qty = parseFloat(document.getElementById(`qty-${rowId}`).value) || 0;
            const price = parseFloat(document.getElementById(`price-${rowId}`).value) || 0;
            const total = qty * price;
            document.getElementById(`rowtotal-${rowId}`).textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            calculateOrderTotal();
        }

        function removeOrderItem(rowId) {
            document.getElementById(`item-row-${rowId}`)?.remove();
            calculateOrderTotal();
        }

        function calculateOrderTotal() {
            let subtotal = 0;
            document.querySelectorAll('[id^="rowtotal-"]').forEach(el => {
                subtotal += parseFloat(el.textContent.replace('$', '').replace(/,/g, '')) || 0;
            });
            const discount = parseFloat(document.getElementById('orderDiscount')?.value) || 0;
            const orderTotal = subtotal - discount;
            
            const includeVat = document.getElementById('includeVat')?.checked || false;
            const totalToPay = includeVat ? orderTotal * 1.18 : orderTotal;
            
            document.getElementById('subtotalDisplay').textContent = `$${subtotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('orderTotalDisplay').textContent = `$${orderTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalDisplay').textContent = `$${totalToPay.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalDisplayBottom').textContent = `$${totalToPay.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            calculateBalance();
        }

        // ========== ×©×•×¨×•×ª ×ª×©×œ×•× ==========
        function addPaymentRow(existingData = null) {
            paymentRowCounter++;
            const rowId = paymentRowCounter;
            const tbody = document.getElementById('paymentRowsBody');
            const today = new Date().toISOString().split('T')[0];
            
            let amountILS = existingData?.amount || 0;
            if (existingData?.currency === 'USD') {
                amountILS = existingData.amount * (existingData.exchange_rate || currentExchangeRate);
            }
            
            const row = document.createElement('tr');
            row.id = `payment-row-${rowId}`;
            row.className = 'border-b hover:bg-purple-50';
            row.innerHTML = `
                <td class="px-3 py-2">${rowId}</td>
                <td class="px-3 py-2">
                    <input type="date" id="pay-date-${rowId}" class="w-28 border rounded px-2 py-1 text-sm" value="${existingData?.payment_date || today}">
                </td>
                <td class="px-3 py-2">
                    <input type="number" id="pay-amount-${rowId}" step="0.01" class="w-20 border rounded px-2 py-1 text-sm" oninput="calculatePaymentILS(${rowId})" value="${existingData?.amount || ''}">
                </td>
                <td class="px-3 py-2">
                    <select id="pay-currency-${rowId}" class="border rounded px-2 py-1 text-sm" onchange="calculatePaymentILS(${rowId})">
                        <option value="ILS" ${existingData?.currency === 'ILS' ? 'selected' : ''}>â‚ª</option>
                        <option value="USD" ${existingData?.currency === 'USD' ? 'selected' : ''}>$</option>
                    </select>
                </td>
                <td class="px-3 py-2">
                    <input type="number" id="pay-rate-${rowId}" step="0.01" class="w-16 border rounded px-2 py-1 text-sm" value="${existingData?.exchange_rate || currentExchangeRate}" oninput="calculatePaymentILS(${rowId})">
                </td>
                <td class="px-3 py-2">
                    <span id="pay-ils-${rowId}" class="font-bold text-green-600">â‚ª${amountILS.toFixed(2)}</span>
                </td>
                <td class="px-3 py-2">
                    <select id="pay-method-${rowId}" class="border rounded px-2 py-1 text-sm">
                        <option value="××–×•××Ÿ" ${existingData?.payment_method === '××–×•××Ÿ' ? 'selected' : ''}>××–×•××Ÿ</option>
                        <option value="×”×¢×‘×¨×”" ${existingData?.payment_method === '×”×¢×‘×¨×” ×‘× ×§××™×ª' ? 'selected' : ''}>×”×¢×‘×¨×”</option>
                        <option value="×¦'×§" ${existingData?.payment_method === "×¦'×§" ? 'selected' : ''}>×¦'×§</option>
                        <option value="××©×¨××™" ${existingData?.payment_method === '××©×¨××™' ? 'selected' : ''}>××©×¨××™</option>
                        <option value="×‘×™×˜" ${existingData?.payment_method === '×‘×™×˜' ? 'selected' : ''}>×‘×™×˜</option>
                    </select>
                </td>
                <td class="px-3 py-2">
                    <input type="text" id="pay-ref-${rowId}" class="w-20 border rounded px-2 py-1 text-sm" value="${existingData?.reference_number || ''}">
                </td>
                <td class="px-3 py-2 text-center">
                    <button type="button" onclick="removePaymentRow(${rowId})" class="text-red-500 hover:text-red-700">âœ•</button>
                </td>
            `;
            tbody.appendChild(row);
            calculatePaymentILS(rowId);
        }

        function calculatePaymentILS(rowId) {
            const amount = parseFloat(document.getElementById(`pay-amount-${rowId}`)?.value) || 0;
            const currency = document.getElementById(`pay-currency-${rowId}`)?.value;
            const rate = parseFloat(document.getElementById(`pay-rate-${rowId}`)?.value) || currentExchangeRate;
            
            let amountILS = amount;
            if (currency === 'USD') {
                amountILS = amount * rate;
            }
            
            document.getElementById(`pay-ils-${rowId}`).textContent = `â‚ª${amountILS.toFixed(2)}`;
            calculateTotalPaid();
        }

        function removePaymentRow(rowId) {
            document.getElementById(`payment-row-${rowId}`)?.remove();
            calculateTotalPaid();
        }

        function calculateTotalPaid() {
            let total = 0;
            document.querySelectorAll('[id^="pay-ils-"]').forEach(el => {
                total += parseFloat(el.textContent.replace('â‚ª', '').replace(/,/g, '')) || 0;
            });
            document.getElementById('totalPaidDisplay').textContent = `â‚ª${total.toFixed(2)}`;
            calculateBalance();
        }

        function calculateBalance() {
            const totalToPay = parseFloat(document.getElementById('totalDisplay')?.textContent.replace('$', '').replace(/,/g, '')) || 0;
            const totalToPayILS = totalToPay * currentExchangeRate;
            const totalPaidILS = parseFloat(document.getElementById('totalPaidDisplay')?.textContent.replace('â‚ª', '').replace(/,/g, '')) || 0;
            const balance = totalToPayILS - totalPaidILS;
            
            const balanceEl = document.getElementById('balanceDisplay');
            if (balanceEl) {
                balanceEl.textContent = `â‚ª${balance.toFixed(2)}`;
                balanceEl.className = balance > 0 ? 'px-4 py-3 font-bold text-red-600' : 'px-4 py-3 font-bold text-green-600';
            }
        }

        function getPaymentRowsData() {
            const payments = [];
            document.querySelectorAll('[id^="payment-row-"]').forEach(row => {
                const rowId = row.id.replace('payment-row-', '');
                const amount = parseFloat(document.getElementById(`pay-amount-${rowId}`)?.value) || 0;
                if (amount > 0) {
                    const currency = document.getElementById(`pay-currency-${rowId}`)?.value;
                    const rate = parseFloat(document.getElementById(`pay-rate-${rowId}`)?.value) || currentExchangeRate;
                    let amountILS = currency === 'USD' ? amount * rate : amount;
                    
                    payments.push({
                        amount: amount,
                        currency: currency,
                        exchange_rate: rate,
                        amount_ils: amountILS,
                        payment_method: document.getElementById(`pay-method-${rowId}`)?.value,
                        reference_number: document.getElementById(`pay-ref-${rowId}`)?.value,
                        payment_date: document.getElementById(`pay-date-${rowId}`)?.value || new Date().toISOString().split('T')[0]
                    });
                }
            });
            return payments;
        }

        // ========== ×˜×•×¤×¡ ×”×–×× ×” ==========
        async function generateOrderNumber() {
            const { data } = await supabaseClient
                .from('orders')
                .select('order_number')
                .like('order_number', '25-%')
                .order('order_number', { ascending: false })
                .limit(1);
            
            let nextNumber = 1000;
            if (data && data.length > 0 && data[0].order_number) {
                const lastNum = parseInt(data[0].order_number.split('-')[1]) || 999;
                nextNumber = lastNum + 1;
            }
            return `25-${nextNumber}`;
        }

        function getOrderItemsData() {
            const items = [];
            document.querySelectorAll('[id^="item-row-"]').forEach(row => {
                const rowId = row.id.replace('item-row-', '');
                const qty = parseFloat(document.getElementById(`qty-${rowId}`)?.value) || 0;
                const price = parseFloat(document.getElementById(`price-${rowId}`)?.value) || 0;
                if (qty > 0) {
                    items.push({
                        product_type: document.getElementById(`product-${rowId}`)?.value || '×©×™×¢×¨',
                        quantity: qty,
                        unit_price: price,
                        total_price: qty * price
                    });
                }
            });
            return items;
        }

        async function showAddForm() { 
            document.getElementById('formContainer').classList.remove('hidden'); 
            document.getElementById('formTitle').textContent = '×”×–×× ×” ×—×“×©×”'; 
            document.getElementById('orderId').value = ''; 
            document.getElementById('orderForm').reset(); 
            document.getElementById('order_date').value = new Date().toISOString().split('T')[0];
            document.getElementById('orderDiscount').value = '';
            document.getElementById('includeVat').checked = false;
            document.getElementById('orderItemsBody').innerHTML = '';
            document.getElementById('paymentRowsBody').innerHTML = '';
            itemCounter = 0;
            paymentRowCounter = 0;
            
            const orderNumber = await generateOrderNumber();
            document.getElementById('order_number').value = orderNumber;
            
            addOrderItem();
            calculateOrderTotal();
            calculateTotalPaid();
        }

        function hideForm() { 
            document.getElementById('formContainer').classList.add('hidden'); 
        }

        async function editOrder(id) { 
            const o = orders.find(x => x.id === id); 
            if (!o) return;
            
            const { data: items } = await supabaseClient.from('order_items').select('*').eq('order_id', id);
            const { data: payments } = await supabaseClient.from('payments').select('*').eq('order_id', id);
            
            document.getElementById('formTitle').textContent = '×¢×¨×™×›×ª ×”×–×× ×”'; 
            document.getElementById('orderId').value = o.id; 
            document.getElementById('order_number').value = o.order_number || '';
            document.getElementById('customer_id').value = o.customer_id || ''; 
            document.getElementById('order_date').value = o.order_date || ''; 
            document.getElementById('orderDiscount').value = o.discount || '';
            document.getElementById('includeVat').checked = o.include_vat || false;
            document.getElementById('notes').value = o.notes || ''; 
            
            document.getElementById('orderItemsBody').innerHTML = '';
            document.getElementById('paymentRowsBody').innerHTML = '';
            itemCounter = 0;
            paymentRowCounter = 0;
            
            if (items && items.length > 0) {
                items.forEach(item => addOrderItem(item));
            } else {
                addOrderItem();
            }
            
            if (payments && payments.length > 0) {
                payments.forEach(payment => addPaymentRow(payment));
            }
            
            calculateOrderTotal();
            calculateTotalPaid();
            document.getElementById('formContainer').classList.remove('hidden'); 
        }

        async function saveOrder(event) {
            event.preventDefault();
            const btn = document.getElementById('saveBtn');
            setLoading(btn, true);
            
            const idValue = document.getElementById('orderId').value;
            const id = idValue && idValue.trim() !== '' ? idValue : null;
            const items = getOrderItemsData();
            const payments = getPaymentRowsData();
            const subtotal = items.reduce((sum, item) => sum + item.total_price, 0);
            const discount = parseFloat(document.getElementById('orderDiscount')?.value) || 0;
            const totalAfterDiscount = subtotal - discount;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount_ils, 0);
            const includeVat = document.getElementById('includeVat')?.checked || false;
            
            const customerIdValue = document.getElementById('customer_id').value;
            const customerId = customerIdValue && customerIdValue.trim() !== '' ? customerIdValue : null;
            
            const orderData = { 
                order_number: document.getElementById('order_number').value,
                customer_id: customerId, 
                order_date: document.getElementById('order_date').value || null, 
                status: '×¤×ª×•×—', 
                discount: discount,
                include_vat: includeVat,
                total_amount: totalAfterDiscount,
                paid_amount: totalPaid,
                balance: totalAfterDiscount - totalPaid,
                payment_status: totalPaid >= totalAfterDiscount ? '×©×•×œ× ×‘××œ×•××•' : totalPaid > 0 ? '×©×•×œ× ×—×œ×§×™×ª' : '×œ× ×©×•×œ×',
                notes: document.getElementById('notes').value 
            };
            
            try {
                let orderId = id;
                
                if (id) {
                    const { error } = await supabaseClient.from('orders').update(orderData).eq('id', id);
                    if (error) throw error;
                    await supabaseClient.from('order_items').delete().eq('order_id', id);
                    await supabaseClient.from('payments').delete().eq('order_id', id);
                } else {
                    const { data, error } = await supabaseClient.from('orders').insert([orderData]).select();
                    if (error) throw error;
                    orderId = data[0].id;
                }
                
                if (items.length > 0) {
                    const itemsWithOrderId = items.map(item => ({ ...item, order_id: orderId }));
                    await supabaseClient.from('order_items').insert(itemsWithOrderId);
                }
                
                if (payments.length > 0) {
                    const paymentsWithIds = payments.map(p => ({ ...p, order_id: orderId, customer_id: customerId }));
                    await supabaseClient.from('payments').insert(paymentsWithIds);
                }
                
                showToast(id ? '×”×”×–×× ×” ×¢×•×“×›× ×”!' : '×”×”×–×× ×” × ×•×¡×¤×”!');
                hideForm();
                setTimeout(() => location.reload(), 500);
            } catch (error) {
                showToast('×©×’×™××”: ' + error.message, 'error');
            }
            
            setLoading(btn, false);
        }

        async function deleteOrder(id) { 
            if (!confirm('×œ××—×•×§ ××ª ×”×”×–×× ×”?')) return; 
            await supabaseClient.from('order_items').delete().eq('order_id', id);
            await supabaseClient.from('payments').delete().eq('order_id', id);
            await supabaseClient.from('orders').delete().eq('id', id); 
            showToast('×”×”×–×× ×” × ××—×§×”');
            loadOrders(); 
        }

        // ========== ×”×¤×§×ª ×ª.××©×œ×•×— ==========
        function confirmDeliveryNote() {
            document.getElementById('deliveryConfirmModal').classList.remove('hidden');
        }
        
        function closeDeliveryConfirm() {
            document.getElementById('deliveryConfirmModal').classList.add('hidden');
        }
        
        async function generateDeliveryNote() {
            const orderId = document.getElementById('orderId').value;
            if (!orderId) { showToast('×™×© ×œ×©××•×¨ ××ª ×”×”×–×× ×” ×§×•×“×', 'error'); return; }
            
            const order = orders.find(o => o.id === orderId);
            const customer = customers.find(c => c.id === order?.customer_id);
            
            // ×§×‘×œ×ª ××¡×¤×¨ ×ª.××©×œ×•×— ×”×‘×
            const { data: lastDN } = await supabaseClient
                .from('orders')
                .select('delivery_note_number')
                .not('delivery_note_number', 'is', null)
                .order('delivery_note_number', { ascending: false })
                .limit(1);
            
            let nextDN = 1000;
            if (lastDN && lastDN.length > 0) {
                const lastNum = parseInt(lastDN[0].delivery_note_number.split('-')[1]) || 999;
                nextDN = lastNum + 1;
            }
            const dnNumber = `DN-${nextDN}`;
            
            // ×¢×“×›×•×Ÿ ×”×”×–×× ×”
            await supabaseClient.from('orders').update({ delivery_note_number: dnNumber }).eq('id', orderId);
            
            // *** ×©××™×¨×” ×‘×˜×‘×œ×ª invoices ***
            await supabaseClient.from('invoices').insert({
                invoice_number: dnNumber,
                order_id: orderId,
                customer_id: order?.customer_id,
                invoice_date: new Date().toISOString().split('T')[0],
                total_amount: order?.total_amount || 0,
                status: '×ª×¢×•×“×ª ××©×œ×•×—',
                type: 'delivery_note'
            });
            
            closeDeliveryConfirm();
            showToast('×ª×¢×•×“×ª ××©×œ×•×— ' + dnNumber + ' ×”×•×¤×§×”!');
            
            // ×”×“×¤×¡×”
            await printDocument(orderId, dnNumber, 'delivery');
            loadOrders();
        }

        // ========== ×”×¤×§×ª ×—×©×‘×•× ×™×ª ==========
        function confirmInvoice() {
            document.getElementById('invoiceConfirmModal').classList.remove('hidden');
        }
        
        function closeInvoiceConfirm() {
            document.getElementById('invoiceConfirmModal').classList.add('hidden');
        }
        
        async function generateInvoice() {
            const orderId = document.getElementById('orderId').value;
            if (!orderId) { showToast('×™×© ×œ×©××•×¨ ××ª ×”×”×–×× ×” ×§×•×“×', 'error'); return; }
            
            const order = orders.find(o => o.id === orderId);
            const customer = customers.find(c => c.id === order?.customer_id);
            
            // ×§×‘×œ×ª ××¡×¤×¨ ×—×©×‘×•× ×™×ª ×”×‘×
            const { data: lastInvoice } = await supabaseClient
                .from('invoices')
                .select('invoice_number')
                .like('invoice_number', '2025-%')
                .order('invoice_number', { ascending: false })
                .limit(1);
            
            let nextInvoiceNum = 2000;
            if (lastInvoice && lastInvoice.length > 0 && lastInvoice[0].invoice_number) {
                const lastNum = parseInt(lastInvoice[0].invoice_number.split('-')[1]) || 1999;
                nextInvoiceNum = lastNum + 1;
            }
            const invoiceNumber = `2025-${nextInvoiceNum}`;
            
            // ×¢×“×›×•×Ÿ ×”×”×–×× ×”
            await supabaseClient.from('orders').update({ invoice_number: invoiceNumber }).eq('id', orderId);
            
            // *** ×©××™×¨×” ×‘×˜×‘×œ×ª invoices ***
            const exchangeRate = currentExchangeRate;
            const subtotalUSD = order?.total_amount || 0;
            const subtotalILS = subtotalUSD * exchangeRate;
            const vat = subtotalILS * 0.18;
            const totalILS = subtotalILS + vat;
            
            await supabaseClient.from('invoices').insert({
                invoice_number: invoiceNumber,
                order_id: orderId,
                customer_id: order?.customer_id,
                invoice_date: new Date().toISOString().split('T')[0],
                total_amount: totalILS,
                vat_amount: vat,
                status: '×××ª×™×Ÿ ×œ×ª×©×œ×•×',
                type: 'invoice'
            });
            
            closeInvoiceConfirm();
            showToast('×—×©×‘×•× ×™×ª ' + invoiceNumber + ' ×”×•×¤×§×”!');
            
            // ×”×“×¤×¡×”
            await printDocument(orderId, invoiceNumber, 'invoice');
            loadOrders();
        }

        // ========== ×”×“×¤×¡×ª ××¡××š ==========
        async function printDocument(orderId, docNumber, type) {
            const order = orders.find(o => o.id === orderId);
            const customer = customers.find(c => c.id === order?.customer_id);
            const { data: items } = await supabaseClient.from('order_items').select('*').eq('order_id', orderId);
            
            const exchangeRate = currentExchangeRate;
            const isInvoice = type === 'invoice';
            const title = isInvoice ? '×—×©×‘×•× ×™×ª ××¡ / ×§×‘×œ×”' : '×ª×¢×•×“×ª ××©×œ×•×—';
            
            let totalAmount = 0;
            const itemsHtml = (items || []).map((item, i) => {
                const unitPrice = isInvoice ? (item.unit_price || 0) * exchangeRate : (item.unit_price || 0);
                const totalPrice = (item.quantity || 0) * unitPrice;
                totalAmount += totalPrice;
                const currency = isInvoice ? 'â‚ª' : '$';
                return `
                    <tr style="background: ${i % 2 === 0 ? '#fff' : '#f8f9fa'};">
                        <td style="padding: 12px; border: 1px solid #ddd;">${i + 1}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${item.product_type || '×©×™×¢×¨'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${item.quantity}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${currency}${unitPrice.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${currency}${totalPrice.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            let summaryHtml = '';
            if (isInvoice) {
                const vat = totalAmount * 0.18;
                const total = totalAmount + vat;
                summaryHtml = `
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <div style="width: 280px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span>
                                <span>â‚ª${totalAmount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>××¢"× (18%):</span>
                                <span>â‚ª${vat.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; border-top: 2px solid #d4af37; padding-top: 10px;">
                                <span>×¡×”"×› ×œ×ª×©×œ×•×:</span>
                                <span>â‚ª${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                summaryHtml = `
                    <div style="text-align: left; margin-top: 20px; font-size: 20px; font-weight: bold;">
                        ×¡×”"×›: $${totalAmount.toFixed(2)}
                    </div>
                `;
            }
            
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                <div style="padding: 40px; font-family: 'Heebo', sans-serif; direction: rtl;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #d4af37; padding-bottom: 20px;">
                        <div>
                            <h1 style="font-size: 28px; color: #1a1a2e; margin: 0;">${title} ××¡' ${docNumber}</h1>
                            <p style="color: #666; margin: 5px 0;">×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}</p>
                        </div>
                        <img src="logo.jpeg" style="width: 80px; height: 80px; object-fit: contain;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>×¤×¨×˜×™ ×œ×§×•×—:</strong><br>
                            <strong>×©×:</strong> ${customer?.company_name || ''}<br>
                            <strong>××™×© ×§×©×¨:</strong> ${customer?.contact_name || ''}<br>
                            <strong>×›×ª×•×‘×ª:</strong> ${customer?.address || ''}<br>
                            <strong>×˜×œ×¤×•×Ÿ:</strong> ${customer?.phone || ''}
                        </div>
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px;">
                            <strong>×¤×¨×˜×™ ×”×–×× ×”:</strong><br>
                            <strong>××¡' ×”×–×× ×”:</strong> ${order?.order_number || ''}<br>
                            <strong>×ª××¨×™×š ×”×–×× ×”:</strong> ${order?.order_date || ''}
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #1a1a2e; color: white;">
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">#</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">××•×¦×¨</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">×›××•×ª</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">××—×™×¨</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">×¡×”"×›</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    
                    ${summaryHtml}
                    
                    ${order?.notes ? `<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;"><strong>×”×¢×¨×•×ª:</strong> ${order.notes}</div>` : ''}
                </div>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        }

        // ========== ×—×©×‘×•× ×™×ª ×–×™×›×•×™ ==========
        function openCreditModal() {
            const orderId = document.getElementById('orderId').value;
            const orderNum = document.getElementById('order_number').value;
            if (!orderId) { showToast('×™×© ×œ×©××•×¨ ××ª ×”×”×–×× ×” ×§×•×“×', 'error'); return; }
            document.getElementById('creditOrderNumber').textContent = orderNum;
            document.getElementById('creditModal').classList.remove('hidden');
        }
        
        function closeCreditModal() {
            document.getElementById('creditModal').classList.add('hidden');
        }
        
        function calcCredit() {
            const qty = parseFloat(document.getElementById('creditQty').value) || 0;
            const price = parseFloat(document.getElementById('creditPrice').value) || 0;
            document.getElementById('creditTotal').value = '$' + (qty * price).toFixed(2);
        }
        
        async function saveCreditNote() {
            const orderId = document.getElementById('orderId').value;
            const qty = parseFloat(document.getElementById('creditQty').value) || 0;
            const price = parseFloat(document.getElementById('creditPrice').value) || 0;
            const total = qty * price;
            
            if (qty <= 0) { showToast('×™×© ×œ×”×–×™×Ÿ ×›××•×ª', 'error'); return; }
            
            await supabaseClient.from('inventory_movements').insert([{
                action_type: 'credit',
                quantity: qty,
                notes: '×–×™×›×•×™ ××”×–×× ×” ' + document.getElementById('order_number').value
            }]);
            
            await supabaseClient.from('credit_notes').insert([{
                order_id: orderId,
                quantity: qty,
                unit_price: price,
                total_amount: total
            }]);
            
            showToast('×”×–×™×›×•×™ × ×©××¨!');
            closeCreditModal();
        }
        
        async function confirmCreditInvoice() {
            const qty = parseFloat(document.getElementById('creditQty').value) || 0;
            if (qty <= 0) { showToast('×™×© ×œ×”×–×™×Ÿ ×›××•×ª', 'error'); return; }
            
            if (confirm('×”×× ×œ×”×¤×™×§ ×—×©×‘×•× ×™×ª ×–×™×›×•×™?')) {
                await saveCreditNote();
                
                const { data: lastCredit } = await supabaseClient
                    .from('credit_notes')
                    .select('credit_number')
                    .not('credit_number', 'is', null)
                    .order('credit_number', { ascending: false })
                    .limit(1);
                
                let nextCredit = 3000;
                if (lastCredit && lastCredit.length > 0) {
                    const lastNum = parseInt(lastCredit[0].credit_number.split('-')[1]) || 2999;
                    nextCredit = lastNum + 1;
                }
                const creditNumber = `2025-${nextCredit}`;
                
                showToast('×—×©×‘×•× ×™×ª ×–×™×›×•×™ ' + creditNumber + ' ×”×•×¤×§×”!');
            }
        }

        function logout() { localStorage.clear(); sessionStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>
