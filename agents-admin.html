<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×©×‘×•×¨×“ ×¡×•×›× ×™× - ××“××™×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Heebo', sans-serif; }
        .gold-header { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <header class="gold-header shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" alt="Logo" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">×“×©×‘×•×¨×“ ×¡×•×›× ×™×</h1>
                    <p class="text-sm text-gray-700">×¡×™×›×•× ×›×œ ×”×¡×•×›× ×™× ×•×”××›×™×¨×•×ª</p>
                </div>
            </div>
            <a href="dashboard.html" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">
                â† ×—×–×¨×”
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- ×¡×™×›×•× ×›×œ×œ×™ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card p-4 border-r-4 border-blue-500">
                <p class="text-gray-500 text-xs">ğŸ‘¥ ×¡×”"×› ×¡×•×›× ×™×</p>
                <p class="text-3xl font-bold text-blue-600" id="totalAgents">0</p>
            </div>
            <div class="card p-4 border-r-4 border-purple-500">
                <p class="text-gray-500 text-xs">ğŸ“¦ ××œ××™ ××¦×œ ×¡×•×›× ×™×</p>
                <p class="text-3xl font-bold text-purple-600" id="totalInventory">0</p>
                <p class="text-xs text-gray-400">×’×¨×</p>
            </div>
            <div class="card p-4 border-r-4 border-green-500">
                <p class="text-gray-500 text-xs">ğŸ’° ×¡×”"×› ××›×™×¨×•×ª</p>
                <p class="text-3xl font-bold text-green-600" id="totalSales">$0</p>
            </div>
            <div class="card p-4 border-r-4 border-red-500">
                <p class="text-gray-500 text-xs">ğŸ“Š ×œ×ª×©×œ×•× ××¡×•×›× ×™×</p>
                <p class="text-3xl font-bold text-red-600" id="totalOwed">$0</p>
            </div>
        </div>

        <!-- ×˜×‘×œ×ª ×¡×•×›× ×™× ××¤×•×¨×˜×ª -->
        <div class="card p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š ×¡×™×›×•× ×œ×¤×™ ×¡×•×›×Ÿ</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                            <th class="px-4 py-3 text-right">××œ××™ ×”×ª×§×‘×œ</th>
                            <th class="px-4 py-3 text-right">× ××›×¨</th>
                            <th class="px-4 py-3 text-right">××œ××™ × ×•×›×—×™</th>
                            <th class="px-4 py-3 text-right">×¡×”"×› ××›×™×¨×•×ª</th>
                            <th class="px-4 py-3 text-right">×œ×ª×©×œ×•× ×œ×—×‘×¨×”</th>
                        </tr>
                    </thead>
                    <tbody id="agentsSummary"></tbody>
                    <tfoot class="bg-gray-200 font-bold">
                        <tr>
                            <td class="px-4 py-3">×¡×”"×›</td>
                            <td class="px-4 py-3" id="footReceived">0</td>
                            <td class="px-4 py-3" id="footSold">0</td>
                            <td class="px-4 py-3" id="footCurrent">0</td>
                            <td class="px-4 py-3 text-green-600" id="footSalesAmount">$0</td>
                            <td class="px-4 py-3 text-red-600" id="footOwed">$0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- ××›×™×¨×•×ª ××—×¨×•× ×•×ª -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ›’ ××›×™×¨×•×ª ××—×¨×•× ×•×ª (×›×œ ×”×¡×•×›× ×™×)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-right">×ª××¨×™×š</th>
                            <th class="px-3 py-2 text-right">×¡×•×›×Ÿ</th>
                            <th class="px-3 py-2 text-right">×œ×§×•×—</th>
                            <th class="px-3 py-2 text-right">×›××•×ª</th>
                            <th class="px-3 py-2 text-right">××—×™×¨</th>
                            <th class="px-3 py-2 text-right">×¡×”"×›</th>
                        </tr>
                    </thead>
                    <tbody id="recentSales"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        loadAll();

        async function loadAll() {
            await loadAgentsSummary();
            await loadRecentSales();
        }

        async function loadAgentsSummary() {
            const { data: agents } = await supabase.from('agents').select('*').order('name');
            
            if (!agents || !agents.length) {
                document.getElementById('agentsSummary').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">××™×Ÿ ×¡×•×›× ×™×</td></tr>';
                return;
            }

            document.getElementById('totalAgents').textContent = agents.length;

            let totReceived = 0, totSold = 0, totSalesAmount = 0, totOwed = 0;

            const rows = await Promise.all(agents.map(async (a) => {
                const { data: inv } = await supabase.from('agent_inventory').select('quantity_received, total_expected').eq('agent_id', a.id);
                const { data: sales } = await supabase.from('agent_sales').select('quantity_sold, total_amount').eq('agent_id', a.id);

                let received = 0, expected = 0, sold = 0, salesAmount = 0;
                if (inv) inv.forEach(i => { received += Number(i.quantity_received) || 0; expected += Number(i.total_expected) || 0; });
                if (sales) sales.forEach(s => { sold += Number(s.quantity_sold) || 0; salesAmount += Number(s.total_amount) || 0; });

                totReceived += received;
                totSold += sold;
                totSalesAmount += salesAmount;
                totOwed += expected;

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-bold">${a.name}</td>
                        <td class="px-4 py-3">${received.toLocaleString()} ×’×¨×</td>
                        <td class="px-4 py-3">${sold.toLocaleString()} ×’×¨×</td>
                        <td class="px-4 py-3 text-blue-600 font-bold">${(received - sold).toLocaleString()} ×’×¨×</td>
                        <td class="px-4 py-3 text-green-600 font-bold">$${salesAmount.toFixed(2)}</td>
                        <td class="px-4 py-3 text-red-600 font-bold">$${expected.toFixed(2)}</td>
                    </tr>
                `;
            }));

            document.getElementById('agentsSummary').innerHTML = rows.join('');

            // ×¢×“×›×•×Ÿ ×¡×™×›×•××™×
            document.getElementById('totalInventory').textContent = (totReceived - totSold).toLocaleString();
            document.getElementById('totalSales').textContent = '$' + totSalesAmount.toFixed(2);
            document.getElementById('totalOwed').textContent = '$' + totOwed.toFixed(2);

            document.getElementById('footReceived').textContent = totReceived.toLocaleString() + ' ×’×¨×';
            document.getElementById('footSold').textContent = totSold.toLocaleString() + ' ×’×¨×';
            document.getElementById('footCurrent').textContent = (totReceived - totSold).toLocaleString() + ' ×’×¨×';
            document.getElementById('footSalesAmount').textContent = '$' + totSalesAmount.toFixed(2);
            document.getElementById('footOwed').textContent = '$' + totOwed.toFixed(2);
        }

        async function loadRecentSales() {
            const { data } = await supabase
                .from('agent_sales')
                .select('*, agents(name)')
                .order('sale_date', { ascending: false })
                .limit(30);

            const tbody = document.getElementById('recentSales');

            if (!data || !data.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">××™×Ÿ ××›×™×¨×•×ª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(s => `
                <tr class="border-b">
                    <td class="px-3 py-2">${new Date(s.sale_date).toLocaleDateString('he-IL')}</td>
                    <td class="px-3 py-2 font-bold">${s.agents?.name || '-'}</td>
                    <td class="px-3 py-2">${s.customer_name}</td>
                    <td class="px-3 py-2">${s.quantity_sold} ×’×¨×</td>
                    <td class="px-3 py-2">$${Number(s.price_per_unit).toFixed(2)}</td>
                    <td class="px-3 py-2 text-green-600 font-bold">$${Number(s.total_amount).toFixed(2)}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
