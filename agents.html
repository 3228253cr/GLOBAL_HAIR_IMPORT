<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×•×¨×˜×œ ×¡×•×›× ×™× - Global Imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        .login-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; }
        .gold-gradient { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 24px; border-radius: 8px; color: white; }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toastContainer"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-bg flex items-center justify-center p-4">
        <div class="card p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="logo.jpeg" alt="Logo" class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-2xl font-bold text-gray-800">×¤×•×¨×˜×œ ×¡×•×›× ×™×</h1>
                <p class="text-gray-500">Global Imports - Premium Hair Supply</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×©× ××©×ª××©</label>
                    <input type="text" id="loginUsername" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                           placeholder="×”×–×Ÿ ×©× ××©×ª××©">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">×¡×™×¡××”</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                           placeholder="×”×–×Ÿ ×¡×™×¡××”">
                </div>
                <button type="submit" class="w-full gold-gradient text-gray-900 font-bold py-3 rounded-lg hover:opacity-90">
                    ğŸ” ×”×ª×—×‘×¨
                </button>
            </form>
        </div>
    </div>

    <!-- Agent Dashboard -->
    <div id="agentDashboard" class="hidden min-h-screen">
        <header class="gold-gradient shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="logo.jpeg" alt="Logo" class="w-12 h-12 object-contain">
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">×¤×•×¨×˜×œ ×¡×•×›× ×™×</h1>
                        <p class="text-sm text-gray-700">×©×œ×•×, <span id="agentName">×¡×•×›×Ÿ</span></p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    ğŸšª ×”×ª× ×ª×§
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card card p-6 border-r-4 border-blue-500">
                    <p class="text-gray-500 text-sm">ğŸ“¦ ××œ××™ ×©×œ×™</p>
                    <p class="text-3xl font-bold text-blue-600" id="myInventory">0</p>
                    <p class="text-xs text-gray-400">×’×¨×</p>
                </div>
                <div class="stat-card card p-6 border-r-4 border-purple-500">
                    <p class="text-gray-500 text-sm">ğŸ’µ ××—×™×¨ ×¦×¤×•×™ ×œ×™×—×™×“×”</p>
                    <p class="text-3xl font-bold text-purple-600" id="expectedPrice">$0</p>
                    <p class="text-xs text-gray-400">×œ×’×¨×</p>
                </div>
                <div class="stat-card card p-6 border-r-4 border-red-500">
                    <p class="text-gray-500 text-sm">ğŸ’° ×¡×”"×› ×œ×ª×©×œ×•× ×œ×—×‘×¨×”</p>
                    <p class="text-3xl font-bold text-red-600" id="totalOwed">$0</p>
                </div>
                <div class="stat-card card p-6 border-r-4 border-green-500">
                    <p class="text-gray-500 text-sm">âœ… × ××›×¨</p>
                    <p class="text-3xl font-bold text-green-600" id="totalSold">0</p>
                    <p class="text-xs text-gray-400">×’×¨×</p>
                </div>
            </div>

            <!-- ×¨×™×©×•× ××›×™×¨×” -->
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“ ×¨×™×©×•× ××›×™×¨×” ×—×“×©×”</h2>
                    <button onclick="toggleSaleForm()" id="toggleSaleBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        â• ××›×™×¨×” ×—×“×©×”
                    </button>
                </div>

                <div id="saleForm" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
                    <input type="hidden" id="editSaleId">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">×ª××¨×™×š</label>
                            <input type="date" id="saleDate" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">×©× ×œ×§×•×—</label>
                            <input type="text" id="customerName" class="w-full px-4 py-2 border rounded-lg" placeholder="×©× ×”×œ×§×•×—">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">×›××•×ª × ×©×œ×—×” (×’×¨×)</label>
                            <input type="number" id="saleQty" class="w-full px-4 py-2 border rounded-lg" placeholder="0" oninput="calcSaleTotal()">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">××—×™×¨ ×œ×’×¨× ($)</label>
                            <input type="number" step="0.01" id="salePrice" class="w-full px-4 py-2 border rounded-lg" placeholder="0" oninput="calcSaleTotal()">
                        </div>
                    </div>
                    <!-- ×©×“×•×ª ×”×—×–×¨×” ××—×¨×™ ×—×¤×™×¤×” -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div>
                            <label class="block text-yellow-700 font-medium mb-2">ğŸ”„ ×”×•×—×–×¨ ××—×¨×™ ×—×¤×™×¤×”</label>
                            <input type="number" id="returnedQty" class="w-full px-4 py-2 border border-yellow-300 rounded-lg" placeholder="0" oninput="calcSaleTotal()">
                        </div>
                        <div>
                            <label class="block text-green-700 font-medium mb-2">âœ… ×›××•×ª ×¡×•×¤×™×ª</label>
                            <input type="number" id="finalQty" class="w-full px-4 py-2 border rounded-lg bg-green-50 font-bold" readonly>
                        </div>
                        <div>
                            <label class="block text-green-700 font-medium mb-2">ğŸ’° ×¡×”"×› ×œ×ª×©×œ×•×</label>
                            <input type="text" id="saleTotal" class="w-full px-4 py-2 border rounded-lg bg-green-100 font-bold" readonly>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">×”×¢×¨×•×ª</label>
                            <input type="text" id="saleNotes" class="w-full px-4 py-2 border rounded-lg" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveSale()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">ğŸ’¾ ×©××•×¨ ××›×™×¨×”</button>
                        <button onclick="cancelSaleForm()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">×‘×™×˜×•×œ</button>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ××›×™×¨×•×ª</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                <th class="px-4 py-3 text-right">×œ×§×•×—</th>
                                <th class="px-4 py-3 text-right">× ×©×œ×—</th>
                                <th class="px-4 py-3 text-right">×”×•×—×–×¨</th>
                                <th class="px-4 py-3 text-right">×¡×•×¤×™</th>
                                <th class="px-4 py-3 text-right">×¡×”"×›</th>
                                <th class="px-4 py-3 text-right">×”×¢×¨×•×ª</th>
                                <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                        </tbody>
                        <tfoot class="bg-gray-200 font-bold">
                            <tr>
                                <td colspan="2" class="px-4 py-3 text-right">×¡×”"×›:</td>
                                <td class="px-4 py-3 text-right" id="totalQtySent">0</td>
                                <td class="px-4 py-3 text-right text-red-600" id="totalQtyReturned">0</td>
                                <td class="px-4 py-3 text-right" id="totalQtySold">0</td>
                                <td class="px-4 py-3 text-right text-green-600" id="totalSalesAmount">$0</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- ×”×™×¡×˜×•×¨×™×™×ª ×§×‘×œ×ª ××œ××™ -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¥ ×”×™×¡×˜×•×¨×™×™×ª ×§×‘×œ×ª ××œ××™</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                <th class="px-4 py-3 text-right">×›××•×ª ×©×”×ª×§×‘×œ×”</th>
                                <th class="px-4 py-3 text-right">××—×™×¨ ×¦×¤×•×™ ×œ×’×¨×</th>
                                <th class="px-4 py-3 text-right">×¡×”"×› ×¦×¤×•×™</th>
                                <th class="px-4 py-3 text-right">×”×¢×¨×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryHistoryBody">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentAgent = null;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('he-IL');
        }

        function formatNumber(num) {
            return num ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        }

        // Login - ×œ×œ× is_active
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const { data, error } = await supabaseClient
                .from('agents')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .single();

            if (error || !data) {
                showToast('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
                return;
            }

            currentAgent = data;
            localStorage.setItem('agentSession', JSON.stringify(data));
            showAgentDashboard();
            showToast(`×‘×¨×•×š ×”×‘×, ${data.name}!`);
        });

        function showAgentDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('agentDashboard').classList.remove('hidden');
            document.getElementById('agentName').textContent = currentAgent.name;
            document.getElementById('saleDate').valueAsDate = new Date();
            loadAgentData();
        }

        function logout() {
            localStorage.removeItem('agentSession');
            currentAgent = null;
            document.getElementById('agentDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function checkSession() {
            const session = localStorage.getItem('agentSession');
            if (session) {
                currentAgent = JSON.parse(session);
                showAgentDashboard();
            }
        }

        async function loadAgentData() {
            await loadInventoryStats();
            await loadSalesHistory();
            await loadInventoryHistory();
        }

        async function loadInventoryStats() {
            const { data: inventory } = await supabaseClient.from('agent_inventory').select('*').eq('agent_id', currentAgent.id);
            const { data: sales } = await supabaseClient.from('agent_sales').select('*').eq('agent_id', currentAgent.id);

            let totalReceived = 0, totalExpected = 0, avgPrice = 0, totalSold = 0, totalReturned = 0;

            if (inventory && inventory.length > 0) {
                inventory.forEach(inv => {
                    totalReceived += inv.quantity_received || 0;
                    totalExpected += inv.total_expected || 0;
                });
                avgPrice = totalReceived > 0 ? totalExpected / totalReceived : 0;
            }

            if (sales && sales.length > 0) {
                sales.forEach(sale => { 
                    totalSold += sale.quantity_sold || 0;
                    totalReturned += sale.quantity_returned || 0;
                });
            }

            // ××œ××™ × ×•×›×—×™ = ×”×ª×§×‘×œ - × ×©×œ×— + ×”×•×—×–×¨ (××” ×©×”×•×—×–×¨ ×—×–×¨ ×œ××œ××™)
            const currentInventory = totalReceived - totalSold + totalReturned;
            // × ××›×¨ ×‘×¤×•×¢×œ = × ×©×œ×— - ×”×•×—×–×¨
            const actualSold = totalSold - totalReturned;

            document.getElementById('myInventory').textContent = currentInventory.toLocaleString();
            document.getElementById('expectedPrice').textContent = '$' + formatNumber(avgPrice);
            document.getElementById('totalOwed').textContent = '$' + formatNumber(totalExpected);
            document.getElementById('totalSold').textContent = actualSold.toLocaleString();
        }

        async function loadSalesHistory() {
            const { data } = await supabaseClient.from('agent_sales').select('*').eq('agent_id', currentAgent.id).order('sale_date', { ascending: false });
            const tbody = document.getElementById('salesTableBody');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ××›×™×¨×•×ª ×¢×“×™×™×Ÿ</td></tr>';
                document.getElementById('totalQtySent').textContent = '0';
                document.getElementById('totalQtyReturned').textContent = '0';
                document.getElementById('totalQtySold').textContent = '0';
                document.getElementById('totalSalesAmount').textContent = '$0';
                return;
            }

            let totalSent = 0, totalReturned = 0, totalFinal = 0, totalAmount = 0;
            tbody.innerHTML = data.map(sale => {
                const sent = sale.quantity_sold || 0;
                const returned = sale.quantity_returned || 0;
                const final = sent - returned;
                const amount = final * (sale.price_per_unit || 0);
                
                totalSent += sent;
                totalReturned += returned;
                totalFinal += final;
                totalAmount += amount;
                
                return `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${formatDate(sale.sale_date)}</td>
                    <td class="px-4 py-3">${sale.customer_name || ''}</td>
                    <td class="px-4 py-3">${sent.toLocaleString()}</td>
                    <td class="px-4 py-3 ${returned > 0 ? 'text-red-600 font-bold' : ''}">${returned > 0 ? returned.toLocaleString() : '-'}</td>
                    <td class="px-4 py-3 text-green-600 font-bold">${final.toLocaleString()}</td>
                    <td class="px-4 py-3 font-bold text-green-600">$${formatNumber(amount)}</td>
                    <td class="px-4 py-3 text-gray-500">${sale.notes || ''}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editSale('${sale.id}')" class="text-blue-500 hover:text-blue-700 ml-2">âœï¸</button>
                        <button onclick="deleteSale('${sale.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('totalQtySent').textContent = totalSent.toLocaleString();
            document.getElementById('totalQtyReturned').textContent = totalReturned.toLocaleString();
            document.getElementById('totalQtySold').textContent = totalFinal.toLocaleString();
            document.getElementById('totalSalesAmount').textContent = '$' + formatNumber(totalAmount);
        }

        async function loadInventoryHistory() {
            const { data } = await supabaseClient.from('agent_inventory').select('*').eq('agent_id', currentAgent.id).order('date_received', { ascending: false });
            const tbody = document.getElementById('inventoryHistoryBody');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">×œ× ×”×ª×§×‘×œ ××œ××™ ×¢×“×™×™×Ÿ</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(inv => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${formatDate(inv.date_received)}</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${(inv.quantity_received || 0).toLocaleString()} ×’×¨×</td>
                    <td class="px-4 py-3">$${formatNumber(inv.expected_price)}</td>
                    <td class="px-4 py-3 font-bold text-red-600">$${formatNumber(inv.total_expected)}</td>
                    <td class="px-4 py-3 text-gray-500">${inv.notes || ''}</td>
                </tr>
            `).join('');
        }

        function toggleSaleForm() {
            const form = document.getElementById('saleForm');
            const btn = document.getElementById('toggleSaleBtn');
            form.classList.toggle('hidden');
            btn.textContent = form.classList.contains('hidden') ? 'â• ××›×™×¨×” ×—×“×©×”' : 'âœ–ï¸ ×¡×’×•×¨';
            if (!form.classList.contains('hidden')) {
                resetSaleForm();
            }
        }
        
        function cancelSaleForm() {
            document.getElementById('saleForm').classList.add('hidden');
            document.getElementById('toggleSaleBtn').textContent = 'â• ××›×™×¨×” ×—×“×©×”';
            resetSaleForm();
        }
        
        function resetSaleForm() {
            document.getElementById('editSaleId').value = '';
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('customerName').value = '';
            document.getElementById('saleQty').value = '';
            document.getElementById('salePrice').value = '';
            document.getElementById('returnedQty').value = '';
            document.getElementById('finalQty').value = '';
            document.getElementById('saleTotal').value = '';
            document.getElementById('saleNotes').value = '';
        }

        function calcSaleTotal() {
            const qty = parseFloat(document.getElementById('saleQty').value) || 0;
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const returned = parseFloat(document.getElementById('returnedQty').value) || 0;
            const final = qty - returned;
            document.getElementById('finalQty').value = final;
            document.getElementById('saleTotal').value = '$' + formatNumber(final * price);
        }
        
        async function editSale(saleId) {
            const { data } = await supabaseClient.from('agent_sales').select('*').eq('id', saleId).single();
            if (!data) return;
            
            document.getElementById('editSaleId').value = saleId;
            document.getElementById('saleDate').value = data.sale_date || '';
            document.getElementById('customerName').value = data.customer_name || '';
            document.getElementById('saleQty').value = data.quantity_sold || '';
            document.getElementById('salePrice').value = data.price_per_unit || '';
            document.getElementById('returnedQty').value = data.quantity_returned || '';
            document.getElementById('saleNotes').value = data.notes || '';
            
            calcSaleTotal();
            
            document.getElementById('saleForm').classList.remove('hidden');
            document.getElementById('toggleSaleBtn').textContent = 'âœ–ï¸ ×¡×’×•×¨';
        }

        async function saveSale() {
            const editId = document.getElementById('editSaleId').value;
            const saleDate = document.getElementById('saleDate').value;
            const customerName = document.getElementById('customerName').value;
            const qty = parseFloat(document.getElementById('saleQty').value) || 0;
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const returned = parseFloat(document.getElementById('returnedQty').value) || 0;
            const notes = document.getElementById('saleNotes').value;
            
            const finalQty = qty - returned;
            const totalAmount = finalQty * price;

            if (!customerName || qty <= 0) {
                showToast('× × ×œ××œ× ×©× ×œ×§×•×— ×•×›××•×ª', 'error');
                return;
            }
            
            if (returned > qty) {
                showToast('×›××•×ª ×©×”×•×—×–×¨×” ×œ× ×™×›×•×œ×” ×œ×”×™×•×ª ×’×“×•×œ×” ××”×›××•×ª ×©× ×©×œ×—×”', 'error');
                return;
            }

            // ×‘×“×™×§×” ×©×™×© ××¡×¤×™×§ ××œ××™ (×¨×§ ×œ××›×™×¨×” ×—×“×©×”)
            if (!editId) {
                const { data: inventory } = await supabaseClient.from('agent_inventory').select('quantity_received').eq('agent_id', currentAgent.id);
                const { data: sales } = await supabaseClient.from('agent_sales').select('quantity_sold, quantity_returned').eq('agent_id', currentAgent.id);

                let totalReceived = 0, totalSold = 0, totalReturned = 0;
                if (inventory) inventory.forEach(i => totalReceived += i.quantity_received || 0);
                if (sales) sales.forEach(s => {
                    totalSold += s.quantity_sold || 0;
                    totalReturned += s.quantity_returned || 0;
                });
                
                const availableStock = totalReceived - totalSold + totalReturned;

                if (qty > availableStock) {
                    showToast(`××™×Ÿ ××¡×¤×™×§ ××œ××™! ×–××™×Ÿ: ${availableStock} ×’×¨×`, 'error');
                    return;
                }
            }

            const saleData = {
                agent_id: currentAgent.id,
                customer_name: customerName,
                quantity_sold: qty,
                quantity_returned: returned,
                price_per_unit: price,
                total_amount: totalAmount,
                sale_date: saleDate || new Date().toISOString().split('T')[0],
                notes
            };

            let error;
            if (editId) {
                // ×¢×¨×™×›×”
                const result = await supabaseClient.from('agent_sales').update(saleData).eq('id', editId);
                error = result.error;
            } else {
                // ×—×“×©
                const result = await supabaseClient.from('agent_sales').insert(saleData);
                error = result.error;
            }

            if (error) { showToast('×©×’×™××” ×‘×©××™×¨×”', 'error'); console.error(error); return; }

            showToast(editId ? '×”××›×™×¨×” ×¢×•×“×›× ×”!' : '×”××›×™×¨×” × ×©××¨×”!');
            cancelSaleForm();
            loadAgentData();
        }

        async function deleteSale(saleId) {
            if (!confirm('×œ××—×•×§ ××ª ×”××›×™×¨×”?')) return;
            await supabaseClient.from('agent_sales').delete().eq('id', saleId);
            showToast('×”××›×™×¨×” × ××—×§×”');
            loadAgentData();
        }

        checkSession();
    </script>
</body>
</html>
