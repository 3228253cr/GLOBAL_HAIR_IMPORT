<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×¡×•×›× ×™× - Global Imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Heebo', sans-serif; }
        .gold-header { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold; z-index: 9999; }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="toastContainer"></div>

    <!-- Header -->
    <header class="gold-header shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" alt="Logo" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">× ×™×”×•×œ ×¡×•×›× ×™×</h1>
                    <p class="text-sm text-gray-700">×”×¢×‘×¨×ª ××œ××™ ×œ×¡×•×›× ×™×</p>
                </div>
            </div>
            <a href="dashboard.html" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">
                â† ×—×–×¨×”
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- ×”×•×¡×¤×ª ×¡×•×›×Ÿ ×—×“×© -->
        <div class="card p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">â• ×”×•×¡×¤×ª ×¡×•×›×Ÿ ×—×“×©</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="newAgentName" class="px-4 py-2 border rounded-lg" placeholder="×©× ×”×¡×•×›×Ÿ">
                <input type="text" id="newAgentUsername" class="px-4 py-2 border rounded-lg" placeholder="×©× ××©×ª××©">
                <input type="text" id="newAgentPassword" class="px-4 py-2 border rounded-lg" placeholder="×¡×™×¡××”">
                <button id="addAgentBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                    â• ×”×•×¡×£ ×¡×•×›×Ÿ
                </button>
            </div>
        </div>

        <!-- ×¨×©×™××ª ×¡×•×›× ×™× -->
        <div class="card p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ ×¡×•×›× ×™× ×¤×¢×™×œ×™×</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-right">×©×</th>
                            <th class="px-4 py-3 text-right">×©× ××©×ª××©</th>
                            <th class="px-4 py-3 text-right">××œ××™ × ×•×›×—×™</th>
                            <th class="px-4 py-3 text-right">×¡×”"×› ×œ×ª×©×œ×•×</th>
                            <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="agentsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ×”×¢×‘×¨×ª ××œ××™ -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“¦ ×”×¢×‘×¨×ª ××œ××™ ×œ×¡×•×›×Ÿ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 text-sm mb-1">×‘×—×¨ ×¡×•×›×Ÿ</label>
                    <select id="selectAgent" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- ×‘×—×¨ ×¡×•×›×Ÿ --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">×›××•×ª (×’×¨×)</label>
                    <input type="number" id="transferQty" class="w-full px-4 py-2 border rounded-lg" placeholder="0">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">××—×™×¨ ×œ×’×¨× ($)</label>
                    <input type="number" step="0.01" id="transferPrice" class="w-full px-4 py-2 border rounded-lg" placeholder="0">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">×ª××¨×™×š</label>
                    <input type="date" id="transferDate" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">×”×¢×¨×•×ª</label>
                    <input type="text" id="transferNotes" class="w-full px-4 py-2 border rounded-lg" placeholder="××•×¤×¦×™×•× ×œ×™">
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-green-100 px-4 py-2 rounded-lg">
                    <span class="text-gray-600">×¡×”"×›: </span>
                    <span id="transferTotal" class="font-bold text-green-600">$0.00</span>
                </div>
                <button id="transferBtn" class="bg-green-500 text-white px-6 py-2 rounded-lg font-bold">
                    ğŸ“¤ ×”×¢×‘×¨ ××œ××™
                </button>
            </div>
        </div>

        <!-- ×”×™×¡×˜×•×¨×™×™×ª ×”×¢×‘×¨×•×ª -->
        <div class="card p-6 mt-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×”×¢×‘×¨×•×ª</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-right">×ª××¨×™×š</th>
                            <th class="px-3 py-2 text-right">×¡×•×›×Ÿ</th>
                            <th class="px-3 py-2 text-right">×›××•×ª</th>
                            <th class="px-3 py-2 text-right">××—×™×¨</th>
                            <th class="px-3 py-2 text-right">×¡×”"×›</th>
                            <th class="px-3 py-2 text-right">×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="transfersTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let agents = [];

        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
        document.getElementById('transferDate').valueAsDate = new Date();
        loadAgents();
        loadTransfers();

        // ×—×™×©×•×‘ ×¡×”"×›
        document.getElementById('transferQty').addEventListener('input', calcTotal);
        document.getElementById('transferPrice').addEventListener('input', calcTotal);

        function calcTotal() {
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            document.getElementById('transferTotal').textContent = '$' + (qty * price).toFixed(2);
        }

        // ×”×•×¡×¤×ª ×¡×•×›×Ÿ
        document.getElementById('addAgentBtn').addEventListener('click', async function() {
            const name = document.getElementById('newAgentName').value.trim();
            const username = document.getElementById('newAgentUsername').value.trim();
            const password = document.getElementById('newAgentPassword').value.trim();

            if (!name || !username || !password) {
                showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
                return;
            }

            const { error } = await supabase.from('agents').insert({ name, username, password });
            
            if (error) {
                showToast('×©×’×™××” ×‘×”×•×¡×¤×”', 'error');
                return;
            }

            showToast('×”×¡×•×›×Ÿ × ×•×¡×£!', 'success');
            document.getElementById('newAgentName').value = '';
            document.getElementById('newAgentUsername').value = '';
            document.getElementById('newAgentPassword').value = '';
            loadAgents();
        });

        // ×”×¢×‘×¨×ª ××œ××™
        document.getElementById('transferBtn').addEventListener('click', async function() {
            const agentId = document.getElementById('selectAgent').value;
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            const date = document.getElementById('transferDate').value;
            const notes = document.getElementById('transferNotes').value.trim();

            if (!agentId || qty <= 0) {
                showToast('× × ×œ×‘×—×•×¨ ×¡×•×›×Ÿ ×•×›××•×ª', 'error');
                return;
            }

            const { error } = await supabase.from('agent_inventory').insert({
                agent_id: agentId,
                quantity_received: qty,
                expected_price_per_unit: price,
                total_expected: qty * price,
                date_received: date,
                notes: notes
            });

            if (error) {
                showToast('×©×’×™××” ×‘×”×¢×‘×¨×”', 'error');
                console.error(error);
                return;
            }

            showToast('×”××œ××™ ×”×•×¢×‘×¨!', 'success');
            document.getElementById('transferQty').value = '';
            document.getElementById('transferPrice').value = '';
            document.getElementById('transferNotes').value = '';
            document.getElementById('transferTotal').textContent = '$0.00';
            loadAgents();
            loadTransfers();
        });

        // ×˜×¢×™× ×ª ×¡×•×›× ×™×
        async function loadAgents() {
            const { data } = await supabase.from('agents').select('*').order('name');
            agents = data || [];

            // ×¢×“×›×•×Ÿ dropdown
            const select = document.getElementById('selectAgent');
            select.innerHTML = '<option value="">-- ×‘×—×¨ ×¡×•×›×Ÿ --</option>' + 
                agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            // ×¢×“×›×•×Ÿ ×˜×‘×œ×”
            const tbody = document.getElementById('agentsTable');
            
            if (!agents.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">××™×Ÿ ×¡×•×›× ×™×</td></tr>';
                return;
            }

            // ×—×™×©×•×‘ ××œ××™ ×œ×›×œ ×¡×•×›×Ÿ
            const rows = await Promise.all(agents.map(async (a) => {
                const { data: inv } = await supabase.from('agent_inventory').select('quantity_received, total_expected').eq('agent_id', a.id);
                const { data: sales } = await supabase.from('agent_sales').select('quantity_sold').eq('agent_id', a.id);

                let received = 0, expected = 0, sold = 0;
                if (inv) inv.forEach(i => { received += Number(i.quantity_received) || 0; expected += Number(i.total_expected) || 0; });
                if (sales) sales.forEach(s => { sold += Number(s.quantity_sold) || 0; });

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-bold">${a.name}</td>
                        <td class="px-4 py-3 text-gray-600">${a.username}</td>
                        <td class="px-4 py-3 text-blue-600 font-bold">${(received - sold).toLocaleString()} ×’×¨×</td>
                        <td class="px-4 py-3 text-red-600 font-bold">$${expected.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteAgent('${a.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }));

            tbody.innerHTML = rows.join('');
        }

        // ×˜×¢×™× ×ª ×”×¢×‘×¨×•×ª
        async function loadTransfers() {
            const { data } = await supabase.from('agent_inventory').select('*, agents(name)').order('date_received', { ascending: false }).limit(20);
            const tbody = document.getElementById('transfersTable');

            if (!data || !data.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">××™×Ÿ ×”×¢×‘×¨×•×ª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(t => `
                <tr class="border-b">
                    <td class="px-3 py-2">${new Date(t.date_received).toLocaleDateString('he-IL')}</td>
                    <td class="px-3 py-2 font-bold">${t.agents?.name || '-'}</td>
                    <td class="px-3 py-2 text-blue-600">${Number(t.quantity_received).toLocaleString()} ×’×¨×</td>
                    <td class="px-3 py-2">$${Number(t.expected_price_per_unit).toFixed(2)}</td>
                    <td class="px-3 py-2 text-red-600 font-bold">$${Number(t.total_expected).toFixed(2)}</td>
                    <td class="px-3 py-2 text-gray-500">${t.notes || ''}</td>
                </tr>
            `).join('');
        }

        // ××—×™×§×ª ×¡×•×›×Ÿ
        async function deleteAgent(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×¡×•×›×Ÿ?')) return;
            await supabase.from('agents').delete().eq('id', id);
            showToast('×”×¡×•×›×Ÿ × ××—×§', 'success');
            loadAgents();
        }

        // Toast
        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = 'toast toast-' + type;
            t.textContent = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
