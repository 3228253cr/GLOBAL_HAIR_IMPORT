<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×¡×•×›× ×™× - Global Imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        .sidebar { width: 200px; min-height: 100vh; position: fixed; right: 0; top: 0; }
        .main-content { margin-right: 200px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: white; transition: all 0.3s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .gold-gradient { background: linear-gradient(135deg, #c9a227 0%, #d4af37 50%, #e6c84b 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 24px; border-radius: 8px; color: white; }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .tab-btn { padding: 12px 24px; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab-btn.active { border-bottom-color: #d4af37; color: #d4af37; }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toastContainer"></div>

    <!-- ×¡×¨×’×œ ×¦×“ -->
    <aside class="sidebar bg-gray-800 shadow-xl">
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" alt="Logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-white font-bold">Global Imports</h1>
                    <p class="text-gray-400 text-xs">Premium Hair Supply</p>
                </div>
            </div>
        </div>
        
        <nav class="py-4">
            <a href="dashboard.html" class="nav-item"><span>ğŸ“Š</span><span>×“×©×‘×•×¨×“</span></a>
            <a href="suppliers.html" class="nav-item"><span>ğŸ­</span><span>×¡×¤×§×™×</span></a>
            <a href="trips.html" class="nav-item"><span>âœˆï¸</span><span>× ×¡×™×¢×•×ª</span></a>
            <a href="products.html" class="nav-item"><span>ğŸ“¦</span><span>××•×¦×¨×™×</span></a>
            <a href="customers.html" class="nav-item"><span>ğŸ‘¥</span><span>×œ×§×•×—×•×ª</span></a>
            <a href="orders.html" class="nav-item"><span>ğŸ“‹</span><span>×”×–×× ×•×ª</span></a>
            <a href="invoices.html" class="nav-item"><span>ğŸ§¾</span><span>×—×©×‘×•× ×™×•×ª</span></a>
            <a href="inventory.html" class="nav-item">
                <span>ğŸ“¦</span>
                <span>××œ××™</span>
            </a>
            <a href="agents-management.html" class="nav-item active"><span>ğŸ¤</span><span>×¡×•×›× ×™×</span></a>
            <a href="reports.html" class="nav-item"><span>ğŸ“ˆ</span><span>×“×•×—×•×ª</span></a>
            <a href="maintenance.html" class="nav-item"><span>âš™ï¸</span><span>×ª×—×–×•×§×”</span></a>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
            <div class="text-gray-400 text-sm mb-2" id="welcomeUser"></div>
            <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">ğŸšª ×”×ª× ×ª×§</button>
        </div>
    </aside>

    <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
    <div class="main-content">
        <main class="p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ¤ × ×™×”×•×œ ×¡×•×›× ×™×</h1>

            <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 border-r-4 border-blue-500">
                    <p class="text-gray-500 text-sm">ğŸ‘¥ ×¡×•×›× ×™× ×¤×¢×™×œ×™×</p>
                    <p class="text-3xl font-bold text-blue-600" id="totalAgents">0</p>
                </div>
                <div class="card p-6 border-r-4 border-purple-500">
                    <p class="text-gray-500 text-sm">ğŸ“¦ ××œ××™ ××¦×œ ×¡×•×›× ×™×</p>
                    <p class="text-3xl font-bold text-purple-600" id="totalInventoryAtAgents">0</p>
                    <p class="text-xs text-gray-400">×’×¨×</p>
                </div>
                <div class="card p-6 border-r-4 border-green-500">
                    <p class="text-gray-500 text-sm">âœ… × ××›×¨ ×¢"×™ ×¡×•×›× ×™×</p>
                    <p class="text-3xl font-bold text-green-600" id="totalSoldByAgents">0</p>
                    <p class="text-xs text-gray-400">×’×¨×</p>
                </div>
                <div class="card p-6 border-r-4 border-red-500">
                    <p class="text-gray-500 text-sm">ğŸ’° ×¡×”"×› ×—×™×™×‘×™×</p>
                    <p class="text-3xl font-bold text-red-600" id="totalOwedByAgents">$0</p>
                </div>
            </div>

            <!-- ×˜××‘×™× -->
            <div class="card">
                <div class="flex border-b">
                    <button class="tab-btn active" onclick="showTab('agents')">ğŸ‘¥ ×¡×•×›× ×™×</button>
                    <button class="tab-btn" onclick="showTab('inventory')">ğŸ“¦ ×”×¢×‘×¨×ª ××œ××™</button>
                    <button class="tab-btn" onclick="showTab('sales')">ğŸ’° ××›×™×¨×•×ª ×¡×•×›× ×™×</button>
                    <button class="tab-btn" onclick="showTab('status')">ğŸ“Š ×¡×˜×˜×•×¡ ××œ××™</button>
                </div>

                <!-- ×˜××‘ ×¡×•×›× ×™× -->
                <div id="tab-agents" class="tab-content active p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">×¨×©×™××ª ×¡×•×›× ×™×</h2>
                        <button onclick="showAgentForm()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">â• ×¡×•×›×Ÿ ×—×“×©</button>
                    </div>

                    <!-- ×˜×•×¤×¡ ×¡×•×›×Ÿ -->
                    <div id="agentForm" class="hidden bg-blue-50 p-6 rounded-xl mb-6">
                        <h3 class="text-lg font-bold mb-4" id="agentFormTitle">×”×•×¡×¤×ª ×¡×•×›×Ÿ ×—×“×©</h3>
                        <input type="hidden" id="agentId">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×©× ××œ× *</label>
                                <input type="text" id="agentName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×©× ××©×ª××© *</label>
                                <input type="text" id="agentUsername" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×¡×™×¡××” *</label>
                                <input type="text" id="agentPassword" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×˜×œ×¤×•×Ÿ</label>
                                <input type="text" id="agentPhone" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">××™××™×™×œ</label>
                                <input type="email" id="agentEmail" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×¢××œ×” (%)</label>
                                <input type="number" id="agentCommission" step="0.1" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3" value="10">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveAgent()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">ğŸ’¾ ×©××•×¨</button>
                            <button onclick="hideAgentForm()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">×‘×™×˜×•×œ</button>
                        </div>
                    </div>

                    <!-- ×˜×‘×œ×ª ×¡×•×›× ×™× -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">×©×</th>
                                    <th class="px-4 py-3 text-right">××©×ª××©</th>
                                    <th class="px-4 py-3 text-right">×˜×œ×¤×•×Ÿ</th>
                                    <th class="px-4 py-3 text-right">×¢××œ×”</th>
                                    <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ×˜××‘ ×”×¢×‘×¨×ª ××œ××™ -->
                <div id="tab-inventory" class="tab-content p-6">
                    <h2 class="text-xl font-bold mb-6">ğŸ“¦ ×”×¢×‘×¨×ª ××œ××™ ×œ×¡×•×›×Ÿ</h2>
                    
                    <div class="bg-yellow-50 p-6 rounded-xl mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×‘×—×¨ ×¡×•×›×Ÿ</label>
                                <select id="transferAgent" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">-- ×‘×—×¨ --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×›××•×ª (×’×¨×)</label>
                                <input type="number" id="transferQty" class="w-full px-4 py-2 border rounded-lg" onchange="calcTransfer()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">××—×™×¨ ×œ×’×¨× ($)</label>
                                <input type="number" step="0.01" id="transferPrice" class="w-full px-4 py-2 border rounded-lg" onchange="calcTransfer()">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">×¡×”"×› ($)</label>
                                <input type="text" id="transferTotal" class="w-full px-4 py-2 border rounded-lg bg-white font-bold" readonly>
                            </div>
                            <div class="flex items-end">
                                <button onclick="doTransfer()" class="w-full gold-gradient text-gray-900 font-bold py-2 rounded-lg">ğŸ“¤ ×”×¢×‘×¨</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">×”×¢×¨×•×ª</label>
                            <input type="text" id="transferNotes" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                    </div>

                    <h3 class="text-lg font-bold mb-4">×”×™×¡×˜×•×¨×™×™×ª ×”×¢×‘×¨×•×ª</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                    <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                                    <th class="px-4 py-3 text-right">×›××•×ª</th>
                                    <th class="px-4 py-3 text-right">××—×™×¨</th>
                                    <th class="px-4 py-3 text-right">×¡×”"×›</th>
                                    <th class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="transfersTableBody">
                                <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ×˜××‘ ××›×™×¨×•×ª -->
                <div id="tab-sales" class="tab-content p-6">
                    <h2 class="text-xl font-bold mb-6">ğŸ’° ××›×™×¨×•×ª ×¡×•×›× ×™×</h2>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">×¡× ×Ÿ ×œ×¤×™ ×¡×•×›×Ÿ:</label>
                        <select id="filterAgent" class="px-4 py-2 border rounded-lg" onchange="loadSales()">
                            <option value="">×›×œ ×”×¡×•×›× ×™×</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">×ª××¨×™×š</th>
                                    <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                                    <th class="px-4 py-3 text-right">×œ×§×•×—</th>
                                    <th class="px-4 py-3 text-right">×›××•×ª</th>
                                    <th class="px-4 py-3 text-right">××—×™×¨</th>
                                    <th class="px-4 py-3 text-right">×¡×”"×›</th>
                                    <th class="px-4 py-3 text-right">×”×¢×¨×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                            </tbody>
                            <tfoot class="bg-gray-200 font-bold">
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-right">×¡×”"×›:</td>
                                    <td class="px-4 py-3" id="salesTotalQty">0</td>
                                    <td class="px-4 py-3"></td>
                                    <td class="px-4 py-3 text-green-600" id="salesTotalAmount">$0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- ×˜××‘ ×¡×˜×˜×•×¡ ××œ××™ -->
                <div id="tab-status" class="tab-content p-6">
                    <h2 class="text-xl font-bold mb-6">ğŸ“Š ×¡×˜×˜×•×¡ ××œ××™ ×¡×•×›× ×™×</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-right">×¡×•×›×Ÿ</th>
                                    <th class="px-4 py-3 text-right">×§×™×‘×œ</th>
                                    <th class="px-4 py-3 text-right">××›×¨</th>
                                    <th class="px-4 py-3 text-right">× ×•×ª×¨</th>
                                    <th class="px-4 py-3 text-right">×¡×”"×› ×—×™×™×‘</th>
                                    <th class="px-4 py-3 text-right">×¡×˜×˜×•×¡</th>
                                </tr>
                            </thead>
                            <tbody id="statusTableBody">
                                <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://fpsvrqlviyrcifimfcby.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwc3ZycWx2aXlyY2lmaW1mY2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTIzNDAsImV4cCI6MjA4MDk2ODM0MH0.RDRDYCFD4PatNRzKwSzdQg__ZWhIyu4OUq0O8kdrqdE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) { window.location.href = 'index.html'; return; }
            const username = localStorage.getItem('username') || sessionStorage.getItem('username') || '××©×ª××©';
            document.getElementById('welcomeUser').textContent = '×©×œ×•×, ' + username;
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatNumber(num) {
            return num ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString('he-IL') : '';
        }

        // ×˜××‘×™×
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ===== ×¡×•×›× ×™× =====
        function showAgentForm() {
            document.getElementById('agentForm').classList.remove('hidden');
            document.getElementById('agentFormTitle').textContent = '×”×•×¡×¤×ª ×¡×•×›×Ÿ ×—×“×©';
            document.getElementById('agentId').value = '';
            document.getElementById('agentName').value = '';
            document.getElementById('agentUsername').value = '';
            document.getElementById('agentPassword').value = '';
            document.getElementById('agentPhone').value = '';
            document.getElementById('agentEmail').value = '';
            document.getElementById('agentCommission').value = '10';
        }

        function hideAgentForm() {
            document.getElementById('agentForm').classList.add('hidden');
        }

        async function loadAgents() {
            const { data } = await supabase.from('agents').select('*').order('name');
            const tbody = document.getElementById('agentsTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ×¡×•×›× ×™×</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(a => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold">${a.name}</td>
                    <td class="px-4 py-3">${a.username}</td>
                    <td class="px-4 py-3">${a.phone || ''}</td>
                    <td class="px-4 py-3">${a.commission_rate || 10}%</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editAgent('${a.id}')" class="text-blue-500 hover:text-blue-700 mx-1">âœï¸</button>
                        <button onclick="deleteAgent('${a.id}')" class="text-red-500 hover:text-red-700 mx-1">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');

            // ×¢×“×›×•×Ÿ ×“×¨×•×¤×“××•× ×™×
            const options = '<option value="">-- ×‘×—×¨ --</option>' + data.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            document.getElementById('transferAgent').innerHTML = options;
            document.getElementById('filterAgent').innerHTML = '<option value="">×›×œ ×”×¡×•×›× ×™×</option>' + data.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        async function editAgent(id) {
            const { data } = await supabase.from('agents').select('*').eq('id', id).single();
            if (!data) return;
            
            document.getElementById('agentForm').classList.remove('hidden');
            document.getElementById('agentFormTitle').textContent = '×¢×¨×™×›×ª ×¡×•×›×Ÿ';
            document.getElementById('agentId').value = data.id;
            document.getElementById('agentName').value = data.name;
            document.getElementById('agentUsername').value = data.username;
            document.getElementById('agentPassword').value = data.password;
            document.getElementById('agentPhone').value = data.phone || '';
            document.getElementById('agentEmail').value = data.email || '';
            document.getElementById('agentCommission').value = data.commission_rate || 10;
        }

        async function saveAgent() {
            const id = document.getElementById('agentId').value;
            const agent = {
                name: document.getElementById('agentName').value,
                username: document.getElementById('agentUsername').value,
                password: document.getElementById('agentPassword').value,
                phone: document.getElementById('agentPhone').value,
                email: document.getElementById('agentEmail').value,
                commission_rate: parseFloat(document.getElementById('agentCommission').value) || 10
            };

            if (!agent.name || !agent.username || !agent.password) {
                showToast('× × ×œ××œ× ×©×, ××©×ª××© ×•×¡×™×¡××”', 'error');
                return;
            }

            let error;
            if (id) {
                ({ error } = await supabase.from('agents').update(agent).eq('id', id));
            } else {
                ({ error } = await supabase.from('agents').insert(agent));
            }

            if (error) { showToast('×©×’×™××” ×‘×©××™×¨×”: ' + error.message, 'error'); return; }
            
            showToast('× ×©××¨ ×‘×”×¦×œ×—×”!');
            hideAgentForm();
            loadAllData();
        }

        async function deleteAgent(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×¡×•×›×Ÿ?')) return;
            await supabase.from('agents').delete().eq('id', id);
            showToast('× ××—×§');
            loadAllData();
        }

        // ===== ×”×¢×‘×¨×•×ª ××œ××™ =====
        function calcTransfer() {
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            document.getElementById('transferTotal').value = '$' + formatNumber(qty * price);
        }

        async function doTransfer() {
            const agentId = document.getElementById('transferAgent').value;
            const qty = parseFloat(document.getElementById('transferQty').value) || 0;
            const price = parseFloat(document.getElementById('transferPrice').value) || 0;
            const notes = document.getElementById('transferNotes').value;

            if (!agentId) { showToast('×‘×—×¨ ×¡×•×›×Ÿ', 'error'); return; }
            if (qty <= 0) { showToast('×”×–×Ÿ ×›××•×ª', 'error'); return; }

            const { error } = await supabase.from('agent_inventory').insert({
                agent_id: agentId,
                quantity_received: qty,
                expected_price: price,
                total_expected: qty * price,
                date_received: new Date().toISOString().split('T')[0],
                notes
            });

            if (error) { showToast('×©×’×™××”', 'error'); return; }
            
            showToast('×”×•×¢×‘×¨ ×‘×”×¦×œ×—×”!');
            document.getElementById('transferAgent').value = '';
            document.getElementById('transferQty').value = '';
            document.getElementById('transferPrice').value = '';
            document.getElementById('transferTotal').value = '';
            document.getElementById('transferNotes').value = '';
            loadAllData();
        }

        async function loadTransfers() {
            const { data } = await supabase.from('agent_inventory').select('*, agents(name)').order('date_received', { ascending: false });
            const tbody = document.getElementById('transfersTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ×”×¢×‘×¨×•×ª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(t => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${formatDate(t.date_received)}</td>
                    <td class="px-4 py-3 font-bold">${t.agents?.name || ''}</td>
                    <td class="px-4 py-3">${(t.quantity_received || 0).toLocaleString()} ×’×¨×</td>
                    <td class="px-4 py-3">$${formatNumber(t.expected_price)}</td>
                    <td class="px-4 py-3 font-bold text-red-600">$${formatNumber(t.total_expected)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteTransfer('${t.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteTransfer(id) {
            if (!confirm('×œ××—×•×§?')) return;
            await supabase.from('agent_inventory').delete().eq('id', id);
            showToast('× ××—×§');
            loadAllData();
        }

        // ===== ××›×™×¨×•×ª =====
        async function loadSales() {
            const agentId = document.getElementById('filterAgent').value;
            let query = supabase.from('agent_sales').select('*, agents(name)').order('sale_date', { ascending: false });
            if (agentId) query = query.eq('agent_id', agentId);
            
            const { data } = await query;
            const tbody = document.getElementById('salesTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ××›×™×¨×•×ª</td></tr>';
                document.getElementById('salesTotalQty').textContent = '0';
                document.getElementById('salesTotalAmount').textContent = '$0';
                return;
            }

            let totalQty = 0, totalAmount = 0;
            tbody.innerHTML = data.map(s => {
                totalQty += s.quantity_sold || 0;
                totalAmount += s.total_amount || 0;
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${formatDate(s.sale_date)}</td>
                        <td class="px-4 py-3 font-bold">${s.agents?.name || ''}</td>
                        <td class="px-4 py-3">${s.customer_name || ''}</td>
                        <td class="px-4 py-3">${(s.quantity_sold || 0).toLocaleString()}</td>
                        <td class="px-4 py-3">$${formatNumber(s.price_per_unit)}</td>
                        <td class="px-4 py-3 font-bold text-green-600">$${formatNumber(s.total_amount)}</td>
                        <td class="px-4 py-3 text-gray-500">${s.notes || ''}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('salesTotalQty').textContent = totalQty.toLocaleString();
            document.getElementById('salesTotalAmount').textContent = '$' + formatNumber(totalAmount);
        }

        // ===== ×¡×˜×˜×•×¡ =====
        async function loadStatus() {
            const { data: agents } = await supabase.from('agents').select('id, name');
            if (!agents || agents.length === 0) {
                document.getElementById('statusTableBody').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ×¡×•×›× ×™×</td></tr>';
                return;
            }

            const { data: inv } = await supabase.from('agent_inventory').select('agent_id, quantity_received, total_expected');
            const { data: sales } = await supabase.from('agent_sales').select('agent_id, quantity_sold');

            let totalInvAtAgents = 0, totalSold = 0, totalOwed = 0;

            const rows = agents.map(a => {
                let received = 0, owed = 0, sold = 0;
                if (inv) inv.filter(i => i.agent_id === a.id).forEach(i => { received += i.quantity_received || 0; owed += i.total_expected || 0; });
                if (sales) sales.filter(s => s.agent_id === a.id).forEach(s => { sold += s.quantity_sold || 0; });
                const remaining = received - sold;
                
                totalInvAtAgents += remaining;
                totalSold += sold;
                totalOwed += owed;

                const statusClass = remaining === 0 ? 'text-green-600' : remaining < received * 0.2 ? 'text-yellow-600' : 'text-blue-600';
                const statusText = remaining === 0 ? 'âœ… × ××›×¨ ×”×›×œ' : remaining < received * 0.2 ? 'âš ï¸ ×›××¢×˜ × ×’××¨' : 'ğŸ“¦ ×¤×¢×™×œ';

                return `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold">${a.name}</td>
                    <td class="px-4 py-3">${received.toLocaleString()} ×’×¨×</td>
                    <td class="px-4 py-3 text-green-600">${sold.toLocaleString()} ×’×¨×</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${remaining.toLocaleString()} ×’×¨×</td>
                    <td class="px-4 py-3 font-bold text-red-600">$${formatNumber(owed)}</td>
                    <td class="px-4 py-3 ${statusClass}">${statusText}</td>
                </tr>`;
            }).join('');

            document.getElementById('statusTableBody').innerHTML = rows;

            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('totalInventoryAtAgents').textContent = totalInvAtAgents.toLocaleString();
            document.getElementById('totalSoldByAgents').textContent = totalSold.toLocaleString();
            document.getElementById('totalOwedByAgents').textContent = '$' + formatNumber(totalOwed);
        }

        // ×˜×¢×™× ×ª ×”×›×œ
        async function loadAllData() {
            await loadAgents();
            await loadTransfers();
            await loadSales();
            await loadStatus();
        }

        checkLogin();
        loadAllData();
    </script>
</body>
</html>
